  
---
title: 'Lake Erie HABs Community Ecology Manuscript'
output:
  html_document:
    toc: true
---
    




```{r global_options, include=FALSE}

knitr::opts_chunk$set(
  fig.width = 6, 
  fig.height = 5, 
  fig.align = 'center', 
  fig.path = 'Figs/',
  echo = FALSE, 
  warning = FALSE, 
  message = FALSE
)

```


```{r load libraries}

#Load libraries
setwd("~/chabs/miseq_may2015/analysis")
library(phyloseq)
library(DESeq2)
library(ggplot2)
library(plyr)
library(dplyr)
library(scales)
library(grid)
library(reshape2)
library(gridExtra)
library(RColorBrewer)
library(vegan)
library(magrittr)
library(knitr)
library(cowplot)
library(gtable)
source("habs_functions.R")
source("~/git_repos/MicrobeMiseq/R/miseqR.R")
theme_set(theme_bw())
```

```{r mothur import, echo = FALSE}

# Import mothur files and sample metadata
sharedfile = "mothur/allhabs.shared"
taxfile = "mothur/allhabs.taxonomy"
mapfile = "other/habs_metadata.csv"

mothurdata = import_mothur(mothur_shared_file = sharedfile, 
	mothur_constaxonomy_file = taxfile)

# Add the OTU number as a column in the taxonomy file
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
	row.names(tax_table(mothurdata)))

# Rename the taxonomy columns
colnames(tax_table(mothurdata)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")
  
# Import sample metadata and transform into sample_data class
map <- read.csv(mapfile)

# Recode Station
map$Station <- revalue(
  map$Station, 
  c("WE2" = "nearshore", 
  "WE12" = "Toledo", 
  "WE4" = "offshore")
)

# Add shore as a variable
map <-
  map %>% 
    mutate(Shore = as.factor(ifelse(Station == "nearshore" | Station == "Toledo", "nearshore",
                          ifelse(Station == "offshore", "offshore", NA)))
           )
```


```{r}

# Convert map to sample_data class
# Merge mothurdata object with sample_data
map <- sample_data(map)
rownames(map) <- map$SampleID
mothur.merge <- merge_phyloseq(mothurdata, map)
  

# Filter out non-samples (i.e. water, mock) and samples from intensive cruises.
erie.full <-
  mothur.merge %>%
    subset_taxa(
      Kingdom == "Bacteria" &
      Family != "mitochondria" &
      Class != "Chloroplast"
    ) %>%
    subset_samples(
      Type == "sample" & 
      !(Date %in% c("5/27", "6/10", "8/11", "11/3"))
    )

erie <- subset_samples(erie.full, Fraction == "CNA")
    

# Also prune out taxa which were only present in removed samples
erie <- prune_taxa(taxa_sums(erie) > 0, erie)


```


```{r normalization}
## erie.scale

# Scale reads to even depth 
erie.scale <-
  erie %>%
    scale_reads(n = 15000, round = "round") 

erie.scale.format <-
  erie.scale %>%
      refactor_months_and_stations() 

## erie.scale.prune
n = 15000
thresh = 0.001

# Prune low abundance taxa using thresh as mean relative abundance
tax_mean <- taxa_sums(erie.scale)/nsamples(erie.scale)
erie.scale.prune.001 <- prune_taxa(tax_mean > thresh*n, erie.scale)

```


```{r}
# Import metadata file with nutrients, pigments and toxin
nutrient <- read.csv("other/nutrients.csv")


# Format
nutrient <-
  nutrient %>%
    filter(!(Date %in% c("5/27", "6/10", "11/3"))) %>%
    order_dates() 

```
              
              
# Intro
<br>
```{r}
x = 3
```
                     
This is an analysis of the full community ( >0.22um ) Lake Erie HABs samples from June to October 2014. Samples were collected on 19 dates in roughly
weekly intervals. Sample depths were normalized to 15000 reads and at this depth there were a total of `r ntaxa(erie)` OTUs        

<br>      
     
## Research Questions
<br>
```{r}
x = 4
```

***How does bacterial diversity and community composition vary across time and space during a bloom?***

1) Which cyanobacterial taxa make up Lake Erie's bloom? How consistent are dynamics of different Cyanobacterial taxa across space and how predictable are their population dynamics based on water chemistry?

2) Is heterotrophic community composition primarily driven by seasonal progression of physicochemical parameters or does the bloom represent a disturbance that significantly affects seasonal succession?

3) A range of relationships between primary productivity levels and diversity have been shown. Does the Erie HABs bloom lead to a reduction or increase of bacterial diversity?
           
<br>
      
# Results
```{r}
x = 3
```
<br> 
     
## Figure 1: Map
<br>
```{r}
library(ggmap)

myMap <- get_map(
  location = c(lon = -83.3, lat = 41.8),
  source = "google", 
  maptype = "terrain", 
  crop = FALSE
)

mean.phyco <-
  nutrient %>% 
    group_by(Station) %>% 
    summarise(phyco = median(Phycocyanin))

Station = c("nearshore", "Toledo", "offshore")
lat = c(41.7621666, 41.703166, 41.82666)
lng = c(-83.33, -83.25433, -83.193)
Phyco = c(mean.phyco$phyco[1], mean.phyco$phyco[3], mean.phyco$phyco[2])


station.data <- data.frame(Station, lat, lng, Phyco)

ggmap(myMap) +
  geom_point(data = station.data, aes(x = lng, y = lat, size = Phyco), alpha = .8, color = "darkgreen", show_guide = FALSE) +
  annotate('text', x = -83.3, y = 41.795 , label = "nearshore", size = 4) +
  annotate('text', x = -83.24, y = 41.73, label = "Toledo", size = 4) +
  annotate('text', x = -83.18, y = 41.848, label = "offshore", size = 4) 

```
    
**Figure Legend:** Study sampling locations in Western Lake Erie. Point size represents median phycocyanin concentrations across the 3 month study period. Toledo site is near the water intake for the city of Toledo. 

<br> 

## Figure 2: Bloom and Bacterial Composition 

<br>
```{r fig.height=8, fig.width=15}

# Subset to Toledo station
nutrient.we12 <- filter(nutrient, Station == "Toledo" & Fraction == "CNA")


########################### pigment plot #########################
nutrient.we12$highlight.phyco <- NA 
nutrient.we12$highlight.phyco[nutrient.we12$Date %in% c("6/16", "7/29", "10/27")] <- 50

date.color <- c("6/16" = "#070743", "7/29" = "#169D99", "10/27" = "#B9CC01", rep("gray", 16) )

phyco <- 
  ggplot(nutrient.we12, aes(x = Date, y = Phycocyanin, group = Station)) +
    geom_point(size = 1.8, color = "black") +
    geom_line(size = 0.8, color = "black") +
    geom_bar(aes(x = Date, y = highlight.phyco, fill = Date), stat = "identity", alpha = .6, show_guide = FALSE) + 
    scale_fill_manual(values = date.color) +
    xlab("") + 
    ylab("ug/L") + 
    ggtitle("Phycocyanin") +
    theme(
      axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 11, face = "bold"),
      axis.title.y = element_text(size = 14, face = "bold"),
      plot.margin = unit(c(0, 0, 0, 0), "cm"),
      plot.title = element_text(size = 16, face = "bold")
    )  
  

########################### toxin plot #########################
nutrient.we12$highlight.toxin <- NA 
nutrient.we12$highlight.toxin[nutrient.we12$Date %in% c("6/16", "7/29", "10/27")] <- 10

toxin <- 
  ggplot(nutrient.we12, aes(x = Date, y = ParMC, group = Station)) +
    geom_line(size = 0.8, color = "black") +
    geom_point(size = 1.8, color = "black") +
    geom_bar( aes(x = Date, y = highlight.toxin, fill = Date), stat = "identity", alpha = .6, show_guide = FALSE) + 
    scale_fill_manual(values = date.color) +
    xlab("") + 
    ylab("ug/L") + 
    ggtitle("Particulate Microcystin") +
    theme(
      axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 11, face = "bold"),
      axis.title.y = element_text(size = 14, face = "bold"),
      plot.title = element_text(size = 16, face = "bold"),
      plot.margin = unit(c(0, 0, 0, 0), "cm")
    )  



########################### Composition Plots ###############################
erie.toledo <-
  erie.scale %>%
    subset_samples(Date %in% c("6/16", "7/29", "10/27") & Station == "Toledo")
   

erie.toledo <- prune_taxa(taxa_sums(erie.toledo) > 0, erie.toledo)

########################### Phylum Plot ###############################
toledo.long <-
  erie.toledo %>%
  taxglom_and_melt(taxrank = "Phylum", prune = 0.01) %>%
  order_dates()

# Plot
phylum <- 
  ggplot(toledo.long, aes(x = Phylum, y = Abundance, fill = Date, group = Date)) + 
  geom_bar(
    stat = "identity",
    position = "dodge",
    colour = "black",
    alpha = .8,
    show_guide = FALSE
  ) + 
  scale_fill_manual(values = c("#070743","#169D99","#B9CC01"), labels = c("Jun 16", "Jul 29", "Oct 27")) +
  theme(
    axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1, size = 9, face = "bold"),   
    axis.title.y = element_text(size = 13, face = "bold"),
    legend.position = "none",
    legend.key.size = unit(.5, "cm"),
    plot.title = element_text(size = 16, face = "bold"),
    plot.margin = unit(c(0, 1.5, -0.2, 1.5), "cm")
  ) + 
  xlab("") +
  ylab("Rel. Abundance") +
  ggtitle("Phylum Composition")

########################### Cyano Genus Plot ###############################
cyanos.long <-
  erie.toledo %>%
  taxglom_and_melt(taxrank = "Genus", prune = 0.01) %>%
  filter(Class == "Cyanobacteria") %>%
  order_dates()

# Plot 
cyano.genus <-
  ggplot(cyanos.long, aes(x = Genus, y = Abundance, fill = Date, group = Date)) + 
  geom_bar(
    stat = "identity", 
    position = "dodge", 
    colour = "black", 
    alpha = 1,
    show_guide = FALSE
  ) + 
  scale_fill_manual(values = c("#070743","#169D99","#B9CC01"), labels = c("Jun 16", "Jul 29", "Oct 27")) +
  theme(
    axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1, size = 9, face = "bold"),     
    axis.title.y = element_text(size = 13, face = "bold"),
    plot.margin = unit(c(0, 1.5, -.2, 1.5), "cm"),
    plot.title = element_text(size = 16, face = "bold"),
    legend.position = "none"
  ) + 
  xlab("") +
  ylab("Rel. Abundance") +
  ggtitle("Cyano Genus Composition")


######################## Cyano plot #######################
erie.cyano <- 
  erie.scale %>%
    subset_samples(Station == "Toledo") %>%
    subset_taxa(Class != "Cyanobacteria") %>%
    transform_sample_counts(function(x){x/sum(x)}) %>%
    psmelt() %>%
    group_by(Phylum, Date) %>%
    summarise(genAbund = sum(Abundance)) %>%
    group_by(Phylum) %>%
    filter(mean(genAbund) > 0.01) %>%
    order_dates()

cyano.genus <- 
ggplot(erie.cyano, aes(x = Date, y = genAbund, fill = Phylum)) + 
  geom_bar(
    stat = "identity", 
    position = "stack", 
    colour = "black", 
    alpha = 1
  ) + 
  scale_fill_brewer(palette = "Set1") + 
  facet_grid(Phylum~.) + 
  theme(
    axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1, size = 9, face = "bold"),     
    axis.title.y = element_text(size = 13, face = "bold"),
    plot.margin = unit(c(0, 1.5, -.2, 1.5), "cm"),
    plot.title = element_text(size = 16, face = "bold"),
    legend.position = "none"
  ) + 
  xlab("") +
  ylab("Rel. Abundance") +
  ggtitle("Non-cyano Phylum Composition")


########################### Arrange Plots ###############################

g1 <- ggplotGrob(phyco)
g2 <- ggplotGrob(toxin)
g3 <- ggplotGrob(cyano.genus)
g4 <- ggplotGrob(phylum)

ggdraw() +
  draw_plot(rbind(g1, g2, size = "last"), x = 0.02, y = 0.08, width = .45, height = .9) +
  draw_plot(rbind(g3, size = "first"), x = 0.47, y = 0.06, width = .53, height = .92) +
  draw_plot_label(c("A", "B", "C", "D"), c(0.02, 0.02, 0.49, 0.49), c(1, .54, 1, .54), size = 20)

```

**Figure Legend:** A-D: Pigment, toxin, and microbial composition data from Toledo sampling station. Colors of shaded dates in A and B correspond with composition measurements in C and D. The middle date (July 29) was three days before the Toledo water shutoff. C-D: Abundance of Cyanobacteria genera and bacterial Phyla as a fraction of total bacterial reads in a sample. Only genera and Phyla with a relative abundance above 1% in at least one of the three selected dates were included. 

```{r}

nutrient.we12 <- filter(nutrient.we12, Date != "8/11")

phyco <- 
  ggplot(nutrient.we12, aes(x = Date, y = Phycocyanin, group = Station)) +
    geom_point(size = 1.8, color = "black") +
    geom_line(size = 0.8, color = "black") +
    xlab("") + 
    ylab("Phycocyanin") + 
    theme(
      axis.text.x = element_blank(),
      axis.title.y = element_text(size = 14, face = "bold"),
      plot.margin = unit(c(0, 0, 0, 0), "cm")
    )  
  

########################### toxin plot #########################
toxin <- 
  ggplot(nutrient.we12, aes(x = Date, y = ParMC, group = Station)) +
    geom_line(size = 0.8, color = "black") +
    geom_point(size = 1.8, color = "black") +
    xlab("") + 
    ylab("Toxin") + 
    theme(
      axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 9, face = "bold"),    
      axis.title.y = element_text(size = 14, face = "bold"),
      plot.margin = unit(c(0, 0, 0, 0), "cm")
    )  


############### cyano ###################

erie.cyano <- 
  erie.scale %>%
    subset_samples(Station == "Toledo") %>%
    transform_sample_counts(function(x){x/sum(x)}) %>%
    subset_taxa(Class == "Cyanobacteria") %>%
    psmelt() %>%
    group_by(Genus, Date) %>%
    summarise(genAbund = sum(Abundance)) %>%
    group_by(Genus) %>%
    filter(mean(genAbund) > 0.005) %>%
    order_dates()

cyano.genus <- 
ggplot(erie.cyano, aes(x = Date, y = genAbund, fill = Genus)) + 
  geom_bar(
    stat = "identity", 
    position = "stack", 
    colour = "black", 
    alpha = 1
  ) + 
  scale_fill_brewer(palette = "YlGnBu") + 
  facet_grid(Genus~.) + 
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 9, face = "bold"),     
    axis.title.y = element_text(size = 13, face = "bold"),
    plot.margin = unit(c(1, 1.5, -.2, 1.5), "cm"),
    plot.title = element_text(size = 16, face = "bold"),
    legend.position = "none",
    strip.background = element_blank()
  ) + 
  xlab("") +
  ylab("")

####################################

erie.phylum <- 
  erie.scale %>%
    subset_samples(Station == "Toledo") %>%
    transform_sample_counts(function(x){x/sum(x)}) %>%
    psmelt() %>%
    group_by(Phylum, Date) %>%
    summarise(genAbund = sum(Abundance)) %>%
    group_by(Phylum) %>%
    filter(mean(genAbund) > 0.01) %>%
    order_dates()

phylum.plot <- 
ggplot(erie.phylum, aes(x = Date, y = genAbund, fill = Phylum)) + 
  geom_line(
    stat = "identity", 
    position = "stack", 
    colour = "black", 
    alpha = 1
  ) + 
  scale_fill_brewer(palette = "Set1") + 
  facet_grid(Phylum~.) + 
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 9, face = "bold"),     
    axis.title.y = element_text(size = 13, face = "bold"),
    plot.margin = unit(c(0, .5, -.2, .5), "cm"),
    plot.title = element_text(size = 16, face = "bold"),
    strip.background = element_blank(),
    legend.position = "none"
  ) + 
  xlab("") +
  ylab("") 


#################################################


g1 <- ggplotGrob(phyco)
g2 <- ggplotGrob(toxin)
g3 <- ggplotGrob(cyano.genus)
g4 <- ggplotGrob(phylum.plot)

g1 <- gtable_add_cols(g1, g3$widths[6])
g2 <- gtable_add_cols(g2, g3$widths[6])

ggdraw() +
  draw_plot(rbind(g1, g2, g3, size = "last"), x = 0.02, y = 0.02, width = .48, height = .94) +
  draw_plot(g4, x = 0.51, y = .02, width = .45, height = .94) +
  draw_plot_label(c("A", "B", "C"), c(0.02, 0.02, .5), c(1, .65, 1), size = 20)
  
```

<br>

## PERMANOVA

```{r}
# Remove dates for which we are missing samples for any of the sites
stations.date <- subset_samples(erie.scale.format, Date != "9/29")

time.adonis <- 
  phyloseq_to_adonis(
    physeq = stations.date, 
    dist = "bray", 
    formula = "Date"
  ) 

```
         
**Interpretation:**
This is a permanova test in which we look for variance explained by sampling date. 
A majority of the variation between samples can be explained by the date they were taken.
Note: this says nothing about temporal trends as date is treated as a discrete variable here. 

```{r adonis }

station.adonis <- 
  phyloseq_to_adonis(
    physeq = stations.date, 
    dist = "bray", 
    formula = "Shore + Station"
  ) 

```
       
**Interpretation:**
This is a nested permanova test in which we first looked for variance explained by shore (nearshore vs offshore) and then looked for additional variance that
could be explained by station location i.e differences between WE2 and WE12, the two nearshore stations. Our test demonstrates that there are highly significant 
differences between nearshore and offshore stations, although the amount variation explained by this factor is small with respect to the total variation. 
However, there is not a significant difference in community composition between Station 2 and 12, the nearshore stations. 

 

```{r prune}

n = 15000
thresh = 0.005


# Scale reads to even depth 
erie.scale <-
  erie %>%
    scale_reads(n = 15000, round = "round") 
  

# Prune low abundance taxa using thresh as mean relative abundance
tax_mean <- taxa_sums(erie.scale)/nsamples(erie.scale)
erie.scale.prune.005 <- prune_taxa(tax_mean > thresh*n, erie.scale)
```

<br>


## Figure 3: Cyanobacteria vs Heterotroph Bray Curtis time series
<br>
```{r fig.height=7, fig.width=15}
heterotrophs.internal <- 
  erie %>%
  subset_taxa(Class != "Cyanobacteria") %>%
  scale_reads(round = "round")

# Ordinate
htrophs.internal.pcoa <- ordinate(
  physeq = heterotrophs.internal, 
  method = "PCoA", 
  distance = "bray"
)

cyanos.internal <- 
  erie %>%
  subset_taxa(Class == "Cyanobacteria") %>%
  scale_reads(round = "round")

# Ordinate
cyanos.internal.pcoa <- ordinate(
  physeq = cyanos.internal, 
  method = "PCoA", 
  distance = "bray"
)

bray.pc.htrophs <- data.frame(
  SampleID = rownames(htrophs.internal.pcoa$vectors), 
  PC1 = htrophs.internal.pcoa$vectors[ ,1], 
  PC2 = htrophs.internal.pcoa$vectors[ ,2], row.names = NULL
)

bray.pc.cyanos <- data.frame(
  SampleID = rownames(cyanos.internal.pcoa$vectors), 
  PC1 = cyanos.internal.pcoa$vectors[ ,1], 
  PC2 = cyanos.internal.pcoa$vectors[ ,2], row.names = NULL
)


braypc.htrophs.sampledata <- 
  nutrient %>%
    filter(Fraction == "CNA") %>%
    filter(Date != "8/11") %>%
    left_join(bray.pc.htrophs, by = "SampleID")  %>%
    order_dates() 

braypc.htrophs.sampledata$Station <- factor(braypc.htrophs.sampledata$Station, 
  levels = c("nearshore", "Toledo", "offshore"))

# 9/29 date
braypc.htrophs.sampledata <- rbind(braypc.htrophs.sampledata, rep(NA, ncol(braypc.htrophs.sampledata)))
braypc.htrophs.sampledata$Station[nrow(braypc.htrophs.sampledata)] <- "offshore"
braypc.htrophs.sampledata$Date[nrow(braypc.htrophs.sampledata)] <- "9/29"


braypc1.plot <-
  ggplot(braypc.htrophs.sampledata, aes(x = Date, y = PC1, group = Station, color = Station)) +
  geom_line(size = 1.2) + 
  scale_color_manual(values = c("#E96446","#52361b","#87CEFA")) +
  xlab("") + 
  ylab("PC1 (34.8%)") +
  ggtitle("Heterotrophs") + 
  theme(
    axis.text.x = element_blank(),
    axis.title.y = element_text(size = 14),
    legend.position = "none",
    plot.margin = unit(c(1, 1.5, -0.2, 1.5), "cm"),
    plot.title = element_text(size = 18, face = "bold")
  ) 

braypc2.plot <-
  ggplot(braypc.htrophs.sampledata, aes(x = Date, y = PC2, group = Station, color = Station)) +
  geom_line(size = 1.2) + 
  scale_color_manual(values = c("#E96446","#52361b","#87CEFA")) +
  ylab("PC2 (11.0%)") + 
  xlab("") +
  theme(
    axis.text.x = element_text(
      angle = 45, 
      vjust = 1, 
      hjust = 1, 
      size = 14, 
      face = "bold"
      ), 
    axis.title.y = element_text(size = 14),
    legend.position = "none",
    plot.margin = unit(c(-0.2, 1.5, 1, 1.5), "cm")
  )


braypc.cyanos.sampledata <- 
  nutrient %>%
    filter(Fraction == "CNA") %>%
    filter(Date != "8/11") %>%
    left_join(bray.pc.cyanos, by = "SampleID")  %>%
    order_dates() 

braypc.cyanos.sampledata$Station <- factor(braypc.cyanos.sampledata$Station, 
  levels = c("nearshore", "Toledo", "offshore"))

braypc.cyanos.sampledata <- rbind(braypc.cyanos.sampledata, rep(NA, ncol(braypc.cyanos.sampledata)))
braypc.cyanos.sampledata$Station[nrow(braypc.cyanos.sampledata)] <- "offshore"
braypc.cyanos.sampledata$Date[nrow(braypc.cyanos.sampledata)] <- "9/29"

braypc3.plot <-
  ggplot(braypc.cyanos.sampledata, aes(x = Date, y = PC1, group = Station, color = Station)) +
  geom_line(size = 1.2) + 
  scale_color_manual(values = c("#E96446","#52361b","#87CEFA")) +
  xlab("") + 
  ylab("PC1 (36.6%)") +
  ggtitle("Cyanobacteria") +
  theme(
    axis.text.x = element_blank(),
    axis.title.y = element_text(size = 14),
    plot.margin = unit(c(1, 1.5, -0.2, 1.5), "cm"),
    plot.title = element_text(size = 18, face = "bold"),
    legend.position = "bottom"
  ) 

legend <- gtable_filter(ggplot_gtable(ggplot_build(braypc3.plot)), "guide-box") 

braypc3.plot <- braypc3.plot + guides(color = FALSE)

braypc4.plot <-
  ggplot(braypc.cyanos.sampledata, aes(x = Date, y = PC2, group = Station, color = Station)) +
  geom_line(size = 1.2) + 
  scale_color_manual(values = c("#E96446","#52361b","#87CEFA")) +
  ylab("PC2 (10.5%)") + 
  xlab("") +
  theme(
    axis.text.x = element_text(
      angle = 45, 
      vjust = 1, 
      hjust = 1, 
      size = 14, 
      face = "bold"
      ), 
    axis.title.y = element_text(size = 14),
    legend.position = "none",
    plot.margin = unit(c(-0.2, 1.5, 1, 1.5), "cm")
  )

g1 = ggplotGrob(braypc1.plot)
g2 = ggplotGrob(braypc2.plot)
g3 = ggplotGrob(braypc3.plot)
g4 = ggplotGrob(braypc4.plot)


ggdraw() +
  draw_plot(rbind(g3, g4, size = "first"), x = 0.01, y = 0.08, width = .48, height = .92) +
  draw_plot(rbind(g1, g2, size = "first"), x = 0.51, y = 0.08, width = .48, height = .92) +
  draw_plot(legend, x = .47, y = 0.05, width = .1, height = .05) + 
  draw_plot_label(c("A", "B"), c(0.02, 0.5), c(1, 1), size = 20) 
```

**Figure legend**: Principle coordinates axes 1 and 2 of bray-curtis dissimilarity between samples plotted over time. 
Samples were subsetted to either Cyanobacteria in A) or Heterotrophs (all-non Cyanobacteria) in B). 
Relative abundance of OTUs were rescaled to the group of interest i.e. in A) an OTU's relative abundance was calculated as 
the percentage of its reads divided by the total number of Cyanobacterial reads in a sample.
Percentages on the y-axis labels refer to the relative eigenvalue of the principle coordinate with the Lingoes corrections for negative values. 


```{r spearman correlations}

Stations = c("nearshore", "Toledo", "offshore")

make_station_braypc <- function(braypc.df, station) {
  station.braypc <-
    braypc.df %>%
      filter(Date != "9/29") %>%
      filter(Station == station)
  
  return(station.braypc)
}

spearman_corr_pc <- function(pc.station, rnames) {
  
  # PC1 tests
  we2vs12.pc1 <- cor.test(pc.station[["nearshore"]]$PC1, pc.station[["Toledo"]]$PC1, method = "spearman")
  we2vs4.pc1 <- cor.test(pc.station[["nearshore"]]$PC1, pc.station[["offshore"]]$PC1, method = "spearman")
  we4vs12.pc1 <- cor.test(pc.station[["Toledo"]]$PC1, pc.station[["offshore"]]$PC1, method = "spearman")
  
  # PC2 tests
  we2vs12.pc2 <- cor.test(pc.station[["nearshore"]]$PC2, pc.station[["Toledo"]]$PC2, method = "spearman")
  we2vs4.pc2 <- cor.test(pc.station[["nearshore"]]$PC2, pc.station[["offshore"]]$PC2, method = "spearman")
  we4vs12.pc2 <- cor.test(pc.station[["Toledo"]]$PC2, pc.station[["offshore"]]$PC2, method = "spearman")
  
  # Pvalues
  PC1.corr.pvalue <- p.adjust(c(we2vs12.pc1$p.value, we2vs4.pc1$p.value, we4vs12.pc1$p.value), method = "bonferroni")
  PC2.corr.pvalue <- p.adjust(c(we2vs12.pc2$p.value, we2vs4.pc2$p.value, we4vs12.pc2$p.value), method = "bonferroni")
  pc.p <- data.frame(rbind(PC1.corr.pvalue, PC2.corr.pvalue), row.names = c(paste(rnames," PC1"), paste(rnames," PC2")))
  names(pc.p) <- c("nearshore vs Toledo", "nearshore vs offshore", "Toledo vs offshore")
  
  # Estimates
  PC1.corr.est <- c(we2vs12.pc1$estimate, we2vs4.pc1$estimate, we4vs12.pc1$estimate)
  PC2.corr.est <- c(we2vs12.pc2$estimate, we2vs4.pc2$estimate, we4vs12.pc2$estimate)
  pc.corr <- data.frame(rbind(PC1.corr.est, PC2.corr.est), row.names = c(paste(rnames," PC1"), paste(rnames," PC2")))
  names(pc.corr) <- c("nearshore vs Toledo", "nearshore vs offshore", "Toledo vs offshore")
  
  return(list(pval = pc.p, est = pc.corr))
}

############################# Heterotrophs ##############################

# Make heterotroph stations
braypc.htrophs.station <- list()
for (station in Stations) {
  braypc.htrophs.station[[station]] <- make_station_braypc(braypc.htrophs.sampledata, station)
}

htrophs.corr <- spearman_corr_pc(pc.station = braypc.htrophs.station, rnames = "htrophs")

############################# Cyanobacteria ##############################

# Make cyano stations 
braypc.cyano.station <- list()
for (station in Stations) {
  braypc.cyano.station[[station]] <- make_station_braypc(braypc.cyanos.sampledata, station)
}

cyanos.corr <- spearman_corr_pc(pc.station = braypc.cyano.station, rnames = "cyanos")

```
<br>     
      
## Table 1: Spearman's rho correlations between station profiles on PC axes
       
```{r}
library(pander)
pvals <- rbind(cyanos.corr$pval, htrophs.corr$pval)
coefs <- rbind(cyanos.corr$est, htrophs.corr$est)
emphasize.strong.cells(which(pvals < 0.05, arr.ind = TRUE))
pander(coefs, split.tables = Inf)     

```
         
**Table legend**:
Pairwise spearman's rho correlation coefficients between stations profile's on PC1 and PC2. Bolded coefficients were significant with a bonferroni correction at p < 0.05. 

       
## Table 2: env variables associated with community dissimilarity
```{r env variables PC1}
library(leaps)

# Function to run a linear model and return the r-squared and pvalue
get_lm <- function(vars, response, dat) {
  formula = reformulate(termlabels = vars, response = response)
  lm.model <- lm(formula, dat)
  r <- summary(lm.model)$adj.r.squared
  p <- summary(lm.model)$coefficients[-1, 4]
  return(c(r,p))
}

# Function to extract liner model adj. r-squared and pvalue
 

get_bestsub_summary <- function(vars, response, dat) {
  formula = reformulate(termlabels = vars, response = response)
  lm.model <- regsubsets(formula, dat)
  bic <- summary(lm.model)$bic
  cp <- summary(lm.model)$cp
  best.model <- summary(lm.model)$which[which.min(bic), ]
  return(list(model = best.model, bic = bic, cp = cp))
}

env.var <- c("pH", "Turbidity", "Nitrate", "SRP", "Secchi", "Phycocyanin", "DOC", "Temp", "H2O2")

########## Htrophs PC1 ##########################
lm.simple.htrophs.PC1 <- list()

for (var in env.var) {
  lm.simple.htrophs.PC1[[var]] <- get_lm(vars = var, response = "PC1", dat = braypc.htrophs.sampledata)
}

############ Htrophs PC2 #####################
lm.simple.htrophs.PC2 <- list()

for (var in env.var) {
  lm.simple.htrophs.PC2[[var]] <- get_lm(vars = var, response = "PC2", dat = braypc.htrophs.sampledata)
}

######### Cyanos PC1 ####################
lm.simple.cyanos.PC1 <- list()

for (var in env.var) {
  lm.simple.cyanos.PC1[[var]] <- get_lm(vars = var, response = "PC1", dat = braypc.cyanos.sampledata)
}

########## Cyanos PC2 ######################

lm.simple.cyanos.PC2 <- list()

for (var in env.var) {
  lm.simple.cyanos.PC2[[var]] <- get_lm(vars = var, response = "PC2", dat = braypc.cyanos.sampledata)
}

r <- rbind(
  "Cyano PC1" = as.data.frame.list(lm.simple.cyanos.PC1)[1,], 
  "Cyano PC2" = as.data.frame.list(lm.simple.cyanos.PC2)[1,],
  "Htroph PC1" = as.data.frame.list(lm.simple.htrophs.PC1)[1,],
  "Htroph PC2" = as.data.frame.list(lm.simple.htrophs.PC2)[1,]
)

p <- rbind(
  "Cyano PC1" = as.data.frame.list(lm.simple.cyanos.PC1)[2,], 
  "Cyano PC2" = as.data.frame.list(lm.simple.cyanos.PC2)[2,],
  "Htroph PC1" = as.data.frame.list(lm.simple.htrophs.PC1)[2,],
  "Htroph PC2" = as.data.frame.list(lm.simple.htrophs.PC2)[2,]
)

p <- t(apply(p, 1, function(x) {p.adjust(x, method = "bonferroni", n = 9)}))
emphasize.strong.cells(which(p < 0.05, arr.ind = TRUE))  
pander(r, split.tables = Inf)


```


**Table legend:** R^2 of linear models using variables in columns to predict sample positions along principle coordinate axes. Bolded values indicate significance with p < 0.05 with bonferroni correction

<br>  

### Best multivariate model for Heterotrophs PC1    
```{r}
get_bestsub_summary(env.var, "PC1", dat = braypc.htrophs.sampledata)

```

### Best multivariate model for Heterotrophs PC2
```{r}

get_bestsub_summary(env.var, "PC2", dat = braypc.htrophs.sampledata)

```

### Best multivariate model for Cyano PC1

```{r}

get_bestsub_summary(env.var, "PC1", dat = braypc.cyanos.sampledata)

```

### Best multivariate model for Cyano PC2

```{r}

get_bestsub_summary(env.var, "PC2", dat = braypc.cyanos.sampledata)

```

<br>   

## Problems with model assumptions
```{r}
# autocorrelation of error terms
lm.mode <- lm(formula = PC1 ~ pH, data = braypc.htrophs.sampledata)

plot(lm.mode)



df <- data.frame(days = braypc.htrophs.sampledata$Days[1:50], resid = lm.mode$residuals, station = braypc.htrophs.sampledata$Station[1:50])
ggplot(df, aes(x = days, y = resid, group = station, color = station)) + geom_line() + ggtitle("PC1~pH model")

acf(df$resid)
pacf(df$resid)
fit <- arima(df$resid, order = c(4,0,0))
```

```{r}
library(astsa)
sarima(df$resid, 4, 0, 0)

library(nlme)
g  <- gls(PC1 ~ pH, data = braypc.htrophs.sampledata[1:50, ], correlation = corARMA(p = 4, q = 0))

summary(g)

```

## Figure 4: Cyanobacteria OTU heatmaps  
<br>
```{r cyano heatmaps, fig.height = 10, fig.width = 18}
## erie.scale.prune
n = 15000
thresh = 0.0001

# Prune low abundance taxa using thresh as mean relative abundance
tax_mean <- taxa_sums(erie.scale)/nsamples(erie.scale)
erie.scale.prune.0001 <- prune_taxa(tax_mean > thresh*n, erie.scale)

cyanos <-
  erie.scale.prune.0001 %>%
  subset_taxa(Class == "Cyanobacteria")

cyano.otus <- rownames(tax_table(cyanos))
#titles <- c("Microcystis", "Synechococcus-1", "Pseudanabaena", "Synechococcus-2", "unclassified-1", "Anabaena-1", "Synechococcus-4", "Synechococcus-3", "Anabaena-2", "unclassified-2", "unclassified-3")

scaled.cyanos <- list()

for (otu in cyano.otus) {
  
  # Subset taxa to OTU of interest
  cyano.otu <- 
    cyanos %>%
      subset_taxa(Species == otu)
  
  # Scale OTU across all sites
  #cyano.scale <- scale_otu_lineplots(cyano.otu)
  cyano.scale <- psmelt(cyano.otu)
  
  cyano.scale <- order_dates(cyano.scale)
  
  cyano.scale$Station <- factor(cyano.scale$Station, levels = c("offshore", "Toledo", "nearshore"))
  
  scaled.cyanos[[otu]] <- cyano.scale
  
}
names(scaled.cyanos) <- paste(tax_table(cyanos)[,"Genus"], tax_table(cyanos)[,"Species"])


cyano.gplots <- list()

for (i in 1:11) {
  df <- scaled.cyanos[[i]]
  
  gplot <- 
  ggplot(df, aes(x = Date, y = Station) ) +
  geom_tile(aes(fill = Abundance)) +
  scale_fill_gradient(low = "white", high = "#FF3300") +
  ylab("") +
  xlab("") +
  theme(
    axis.text.x = element_text(
      angle = 45, 
      vjust = 1, 
      hjust = 1, 
      size = 10, 
      face = "bold", 
      color = "#4c4c4c"
      ), 
    panel.background = element_rect(fill = "grey"),
    panel.grid.major = element_blank(),
    legend.key.size = unit(.5, "cm"),
    plot.margin = unit(c(-.05, -.05, -.05, -.05), "cm"),
    plot.title = element_text(size = 16, face = "bold"),
    axis.text.y = element_text(
      size = 10, face = "bold", color = "#4c4c4c"
    )
  ) + 
  ggtitle(names(scaled.cyanos)[i])
  
  cyano.gplots[[i]] <- gplot
}

grid.arrange(cyano.gplots[[1]], cyano.gplots[[2]], cyano.gplots[[5]], 
             cyano.gplots[[4]], cyano.gplots[[3]], cyano.gplots[[8]], 
             cyano.gplots[[9]], cyano.gplots[[7]], cyano.gplots[[6]], ncol = 3)



```
    
**Figure legend:** Cyanobacteria OTUs abundance across sampling stations and dates. 
All OTUs with an average relative abundance > .001 (30 reads) are shown. 


## Overabundant heterotrophic OTUs along positive PC1 (high bloom)
<br>
      

```{r}

braypc.htrophs.sampledata <-
  braypc.htrophs.sampledata %>%
    mutate(PC1group = as.factor(
      ifelse(PC1 > 0, 2, 
        ifelse(PC1 < 0, 1, 
          NA)))
    ) 

braypc.htrophs.sampledata <-
  braypc.htrophs.sampledata %>%
    mutate(PC2group = as.factor(
      ifelse(PC2 > 0, "late", 
        ifelse(PC2 < 0, "early", 
          NA)))
    ) 



heteros_deseq <- function(physeq, var) {
   station.deseq <- phyloseq_to_deseq2(physeq, reformulate(var))
   station.deseq = DESeq(station.deseq, test = "Wald", fitType = "parametric")

  res = data.frame(results(station.deseq, cooksCutoff = FALSE))
  res = data.frame(OTU = row.names(res), res)
  alpha = 0.05
  sigtab <-
    res %>%
      filter(padj < alpha) 

  sigtab.station = cbind(sigtab, as(tax_table(physeq)[sigtab$OTU, ], "matrix"))
  
  return(sigtab.station)
   
}

a <- apply(otu_table(erie), MARGIN = 1, function(x) {mean(x)} )

keep <- a > 5

erie.prune <- prune_taxa(keep, erie)

heterotrophs <- 
  erie.prune %>%
    subset_taxa(Phylum != "Cyanobacteria")

sample_data(heterotrophs)$PC1group <- braypc.htrophs.sampledata$PC1group[1:53]
sample_data(heterotrophs)$PC2group <- braypc.htrophs.sampledata$PC2group[1:53]

############################# WE2 ###############################

heteros.we2 <-
  heterotrophs %>%
    subset_samples(Station == "nearshore")

pc1.deseq.we2 <- heteros_deseq(heteros.we2, var = "PC1group")


########### WE12 #########

heteros.we12 <-
  heterotrophs %>%
    subset_samples(Station == "Toledo")

pc1.deseq.we12 <- heteros_deseq(heteros.we12, var = "PC1group")


####### WE4 ###############
heteros.we4 <-
  heterotrophs %>%
    subset_samples(Station == "offshore")

pc1.deseq.we4 <- heteros_deseq(heteros.we4, var = "PC1group")

##############


bloom2 <- filter(pc1.deseq.we2, log2FoldChange > 0)
bloom12 <- filter(pc1.deseq.we12, log2FoldChange > 0)
bloom4 <- filter(pc1.deseq.we4, log2FoldChange > 0)

i <- intersect(bloom2$Species, bloom12$Species)
i <- intersect(i, bloom4$Species)

highbloom.gplots <- list()

# for (otu in i) {
#   highbloom <- subset_taxa(erie.scale.format, Species == otu)
#   highbloom.melt <- psmelt(highbloom)
#   highbloom.melt <- order_dates(highbloom.melt)
#   
#   highbloom.melt$Station <- factor(highbloom.melt$Station, levels = c("offshore", "Toledo", "nearshore"))
#   
#   g1 <- 
#   ggplot(highbloom.melt, aes(x = Date, y = Station) ) +
#   geom_tile(aes(fill = Abundance)) +
#   scale_fill_gradient(low = "white", high = "#FF3300", limits = c(0, max(highbloom.melt$Abundance))) +
#   ylab("") +
#   xlab("") +
#   theme(
#     axis.text.x = element_text(
#       angle = 45, 
#       vjust = 1, 
#       hjust = 1, 
#       size = 10, 
#       face = "bold", 
#       color = "#4c4c4c"
#       ), 
#     panel.background = element_rect(fill = "grey"),
#     panel.grid.major = element_blank(),
#     legend.key.size = unit(.5, "cm"),
#     plot.margin = unit(c(-.05, -.05, -.05, -.05), "cm"),
#     plot.title = element_text(size = 13, face = "bold"),
#     axis.text.y = element_text(
#       size = 10, face = "bold", color = "#4c4c4c"
#     )
#   ) + 
#   ggtitle(paste(highbloom.melt$Phylum, highbloom.melt$Family, highbloom.melt$Species))
#       
#   
#   highbloom.gplots[[otu]] <- g1
#   
# }

pander(tax_table(heterotrophs)[i,], split.tables = Inf)
#do.call("grid.arrange", c(highbloom.gplots, ncol = 4))


```

```{r fig.height=12,fig.width=10}

gplots <- list()

erie.full.scale <-
  scale_reads(erie.full, round = "round")

for (otu in i) {
  sub <- subset_taxa(erie.full, Species == otu)
  p <- psmelt(sub)
  p <- order_dates(p)
  p$Fraction <- factor(p$Fraction, levels = c("CNA", "100LTR", "53LTR", "3NA", "22NA"))
  p$Station <- factor(p$Station, levels = c("nearshore", "Toledo", "offshore"))
  levels(p$Fraction) <- c("Whole", "100", "53", "3", "0.22")
  
  g1 <- 
  ggplot(p, aes(x = Date, y = Abundance, group = Station, color = Station)) +
    facet_grid(Fraction~., scales = "free_y") +
    geom_line() +
    ggtitle(otu) +
    ylab("reads") + 
    scale_color_manual(values = c("#E96446","#52361b","#87CEFA")) +
  xlab("") + 
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_text(size = 14),
    legend.position = "none",
    plot.margin = unit(c(0, 1.5, -0.2, 1.5), "cm"),
    plot.title = element_text(size = 14, face = "bold")
  ) 
  
  gplots[[otu]] <- g1
}

grid.arrange(gplots[[1]], gplots[[2]], gplots[[3]], gplots[[4]], gplots[[5]], gplots[[6]], gplots[[7]], gplots[[8]], gplots[[9]], ncol = 3)



```

**Figure legend:** Heterotrophic bacteria OTUs that were found to be statistically more abundant along the positive axis of Principle Coordinate 1 across all three sites. OTU read abundance is plotted seperately by site and across filter-size fractions.

## Overabundant OTUs along negative PC1 (low bloom)
```{r}

bloom2 <- filter(pc1.deseq.we2, log2FoldChange < 0)
bloom12 <- filter(pc1.deseq.we12, log2FoldChange < 0)
bloom4 <- filter(pc1.deseq.we4, log2FoldChange < 0)

i <- intersect(bloom2$Species, bloom12$Species)
i <- intersect(i, bloom4$Species)

lowbloom.gplots <- list()

for (otu in i) {
  highbloom <- subset_taxa(erie.scale.format, Species == otu)
  highbloom.melt <- psmelt(highbloom)
  highbloom.melt <- order_dates(highbloom.melt)
  
  highbloom.melt$Station <- factor(highbloom.melt$Station, levels = c("offshore", "Toledo", "nearshore"))
  
  g1 <- 
  ggplot(highbloom.melt, aes(x = Date, y = Station) ) +
  geom_tile(aes(fill = Abundance)) +
  scale_fill_gradient(low = "white", high = "#FF3300", limits = c(0, max(highbloom.melt$Abundance))) +
  ylab("") +
  xlab("") +
  theme(
    axis.text.x = element_text(
      angle = 45, 
      vjust = 1, 
      hjust = 1, 
      size = 10, 
      face = "bold", 
      color = "#4c4c4c"
      ), 
    panel.background = element_rect(fill = "grey"),
    panel.grid.major = element_blank(),
    legend.key.size = unit(.5, "cm"),
    plot.margin = unit(c(-.05, -.05, -.05, -.05), "cm"),
    plot.title = element_text(size = 13, face = "bold"),
    axis.text.y = element_text(
      size = 10, face = "bold", color = "#4c4c4c"
    )
  ) + 
  ggtitle(paste(highbloom.melt$Phylum, highbloom.melt$Family, highbloom.melt$Species))
      
  
  lowbloom.gplots[[otu]] <- g1
  
}

pander(tax_table(heterotrophs)[i,], split.tables = Inf)

```

<br>     
   
## Overabundant OTUs along negative PC2 (early season)
```{r}

############################# WE2 ###############################

pc2.deseq.we2 <- heteros_deseq(heteros.we2, var = "PC2group")


########### WE12 #########

pc2.deseq.we12 <- heteros_deseq(heteros.we12, var = "PC2group")


####### WE4 ###############

pc2.deseq.we4 <- heteros_deseq(heteros.we4, var = "PC2group")

##############


############### early #########################
bloom2 <- filter(pc2.deseq.we2, log2FoldChange < 0)
bloom12 <- filter(pc2.deseq.we12, log2FoldChange < 0)
bloom4 <- filter(pc2.deseq.we4, log2FoldChange < 0)

j <- intersect(bloom2$Species, bloom12$Species)
j <- intersect(j, bloom4$Species)

early.gplots <- list()

for (otu in j) {
  highbloom <- subset_taxa(erie.scale.format, Species == otu)
  highbloom.melt <- psmelt(highbloom)
  highbloom.melt <- order_dates(highbloom.melt)
  
  highbloom.melt$Station <- factor(highbloom.melt$Station, levels = c("offshore", "Toledo", "nearshore"))
  
  g1 <- 
  ggplot(highbloom.melt, aes(x = Date, y = Station) ) +
  geom_tile(aes(fill = Abundance)) +
  scale_fill_gradient(low = "white", high = "#FF3300", limits = c(0, max(highbloom.melt$Abundance))) +
  ylab("") +
  xlab("") +
  theme(
    axis.text.x = element_text(
      angle = 45, 
      vjust = 1, 
      hjust = 1, 
      size = 10, 
      face = "bold", 
      color = "#4c4c4c"
      ), 
    panel.background = element_rect(fill = "grey"),
    panel.grid.major = element_blank(),
    legend.key.size = unit(.5, "cm"),
    plot.margin = unit(c(-.05, -.05, -.05, -.05), "cm"),
    plot.title = element_text(size = 13, face = "bold"),
    axis.text.y = element_text(
      size = 10, face = "bold", color = "#4c4c4c"
    )
  ) + 
  ggtitle(paste(highbloom.melt$Phylum, highbloom.melt$Family, highbloom.melt$Species))
      
  
  early.gplots[[otu]] <- g1
  
}


pander(tax_table(heterotrophs)[j,], split.tables = Inf)
```

<br>     
    
## Overabundant OTUs along positive PC2 (late season)

```{r fig.height = 10, fig.width = 18}






bloom2 <- filter(pc2.deseq.we2, log2FoldChange > 0)
bloom12 <- filter(pc2.deseq.we12, log2FoldChange > 0)
bloom4 <- filter(pc2.deseq.we4, log2FoldChange > 0)

i <- intersect(bloom2$Species, bloom12$Species)
i <- intersect(i, bloom4$Species)

late.gplots <- list()

for (otu in i) {
  highbloom <- subset_taxa(erie.scale.format, Species == otu)
  highbloom.melt <- psmelt(highbloom)
  highbloom.melt <- order_dates(highbloom.melt)
  
  highbloom.melt$Station <- factor(highbloom.melt$Station, levels = c("offshore", "Toledo", "nearshore"))
  
  g1 <- 
  ggplot(highbloom.melt, aes(x = Date, y = Station) ) +
  geom_tile(aes(fill = Abundance)) +
  scale_fill_gradient(low = "white", high = "#FF3300", limits = c(0, max(highbloom.melt$Abundance))) +
  ylab("") +
  xlab("") +
  theme(
    axis.text.x = element_text(
      angle = 45, 
      vjust = 1, 
      hjust = 1, 
      size = 10, 
      face = "bold", 
      color = "#4c4c4c"
      ), 
    panel.background = element_rect(fill = "grey"),
    panel.grid.major = element_blank(),
    legend.key.size = unit(.5, "cm"),
    plot.margin = unit(c(-.05, -.05, -.05, -.05), "cm"),
    plot.title = element_text(size = 13, face = "bold"),
    axis.text.y = element_text(
      size = 10, face = "bold", color = "#4c4c4c"
    )
  ) + 
  ggtitle(paste(highbloom.melt$Phylum, highbloom.melt$Family, highbloom.melt$Species))
      
  
  late.gplots[[otu]] <- g1
  
}


#do.call("grid.arrange", c(late.gplots, ncol = 3))

pander(tax_table(heterotrophs)[i,], split.tables = Inf)
```

<br>

## Figure 6: Alpha Diversity

```{r, fig.height=6, fig.width=8.5}

p <- plot_richness(erie, measures = c("Chao1", "InvSimpson"))

p.chao <- 
  p$data %>% 
  filter(variable == "Chao1") %>% 
  order_dates()

p.chao$Station <- factor(p.chao$Station, levels = c("nearshore", "Toledo", "offshore"))

g1 <-
ggplot(p.chao, aes(x = Date, y = value, group = Station, color = Station)) + geom_line() +
  scale_color_manual(values = c("#E96446","#52361b","#87CEFA")) +
  xlab("") + 
  ylab("Chao1") +
  theme(
    axis.text.x = element_blank(),
    axis.title.y = element_text(size = 14),
    plot.margin = unit(c(1, 1.5, -0.2, 1.5), "cm"),
    plot.title = element_text(size = 18, face = "bold")
  ) 

p.invsimp <- 
  p$data %>%
  filter(variable == "InvSimpson") %>%
  order_dates()

p.invsimp$Station <- factor(p.invsimp$Station, levels = c("nearshore", "Toledo", "offshore"))

g2 <- 
ggplot(p.invsimp, aes(x = Date, y = value, group = Station, color = Station)) +   
  geom_line() +
  scale_color_manual(values = c("#E96446","#52361b","#87CEFA")) +
  xlab("") + 
  ylab("Inv. Simpson") +
  theme(
    axis.text.x = element_text(
      angle = 45, 
      vjust = 1, 
      hjust = 1, 
      size = 10, 
      face = "bold"),
    axis.title.y = element_text(size = 14),
    legend.position = "none",
    plot.margin = unit(c(-.2, 1.5, -0.2, 1.5), "cm"),
    plot.title = element_text(size = 18, face = "bold")
  ) 

g1 <- ggplotGrob(g1)
g2 <- ggplotGrob(g2)

g2 <- gtable_add_cols(g2, g1$widths[6])

grid.draw(rbind(g1, g2, size = "first"))

```
**Figure Legend:** Chao1 and Inverse Simpson alpha diversity metrics calculated on samples across sampling dates and sites.

# Horner-devine
```{r}

mytaxa = c("Full", "Non-cyano", "Actinobacteria", "Alphaproteobacteria", "Betaproteobacteria", "Bacteroidetes", "Gammaproteobacteria", "Verrucomicrobia")

############ alpha-proteo #############

act <-
  erie.scale %>%
    subset_taxa(Phylum == "Actinobacteria")

alphaprot <-
  erie.scale %>%
    subset_taxa(Class == "Alphaproteobacteria")

############ beta-proteo
betaprot <-
  erie.scale %>%
    subset_taxa(Class == "Betaproteobacteria")

############ Bacteroidetes ###########
bact <-
  erie.scale %>%
    subset_taxa(Phylum == "Bacteroidetes")

gamma <-
  erie.scale %>%
    subset_taxa(Class == "Gammaproteobacteria")

verr <-
  erie.scale %>%
    subset_taxa(Phylum == "Verrucomicrobia")


full <- erie.scale

noncyano <- 
  erie.scale %>%
    subset_taxa(Class != "Cyanobacteria")


taxa.groups = list(full, noncyano, act, alphaprot, betaprot, bact, gamma, verr)

chao.list <- list()
simp.list <- list()

alphadivplot <- function(df, i, measure, group) {
  
  df <- 
    df %>% 
      select(LogChla, value) %>%
      na.omit()
  
  lm.fit <- lm(value ~ LogChla, data = df)
  
  ggplot(df, aes(x = LogChla, y = value)) + 
    geom_point() +
    scale_color_manual(values = c("#E96446", "#52361b", "#87CEFA")) +
    ylab(measure) +
    ggtitle(group) +
    #geom_smooth(method = "lm") +
    annotate("text", x = 1.45, y = max(df$value) - .03*max(df$value), size = 3, label = paste("P =", signif(summary(lm.fit)$coef[2,4], 5))) 
                     
}

for (i in 1:8) {
  
  p <- plot_richness(taxa.groups[[i]], measures = c("Observed", "InvSimpson"))

  p.chao <- 
    p$data %>% 
    filter(variable == "Observed") %>% 
    order_dates()

  p.chao$Station <- factor(p.chao$Station, levels = c("nearshore", "Toledo", "offshore"))
  
  chao.list[[i]] <- alphadivplot(p.chao, i, "Observed", mytaxa[i])
  
  p.invsimp <- 
    p$data %>%
    filter(variable == "InvSimpson") %>%
    order_dates()

  p.invsimp$Station <- factor(p.invsimp$Station, levels = c("nearshore", "Toledo", "offshore"))
  
  simp.list[[i]] <- alphadivplot(p.invsimp, i, "InvSimpson", mytaxa[i])
  
}

grid.arrange(
  chao.list[[1]], chao.list[[2]], chao.list[[3]], chao.list[[4]], chao.list[[5]], chao.list[[6]], chao.list[[7]], chao.list[[8]],
  simp.list[[1]], simp.list[[2]], simp.list[[3]], simp.list[[4]], simp.list[[5]], simp.list[[6]], simp.list[[7]], simp.list[[8]],
  ncol = 8
)

```


# Supplement 

## S1: PCoA of Bray-Curtis Dissimilarity
```{r echo = FALSE, fig.height = 5, fig.width = 7}

# Ordinate
full.pcoa <- ordinate(
  physeq = erie.scale.format, 
  method = "PCoA", 
  distance = "bray"
)

# Plot 
PCoA <-
  plot_ordination(
    physeq = erie.scale.format,
    ordination = full.pcoa,
    color = "Month",
    shape = "Station",
    title = ""
  ) + 
  scale_color_manual(
    values = c("red", "#ffae19", "#4daf4a", "#1919ff", "darkorchid3", "black")
  ) +
  geom_point(aes(color = Month), alpha = 0.6, size = 4) +
  geom_point(colour = "grey90", size = 1.5)


PCoA

```


## S2: Environmental variables
```{r echo = FALSE, fig.height= 10, fig.width = 10}

# Import metadata file with nutrients, pigments and toxin
nutrient <- read.csv("other/nutrient_cleaned.csv")


# Format
nutrient <-
  nutrient %>%
    filter(!(Date %in% c("5/27","6/10", "11/3"))) %>%
    order_dates() %>%
    mutate(Station = factor(Station, levels = c("nearshore", "Toledo", "offshore")))

nutplots.nutrients <- c("SRP", "Nitrate", "H2O2", "Temp", "Turbidity", "pH", "SpCond", "CDOM_305")
nutplots.titles <- c("SRP", "Nitrate", "H2O2", "Temperature", "Turbidity", "pH", "SpCond", "CDOM")
nutplots <- list()

for (i in 1:length(nutplots.nutrients)) {
  nutplots[[i]] <- nutplot_unpooled(df = nutrient, nutrient = nutplots.nutrients[i], title = nutplots.titles[i])
}


# multiplot
grid_arrange_shared_legend(nutplots[[1]], nutplots[[2]], nutplots[[3]], nutplots[[4]], nutplots[[5]], nutplots[[6]])

```


## S3 Cyanobacteria station vs station bray-curtis heatmaps

```{r fig.height=7, fig.width=22}
 
cyanos.noscale <-
   erie.scale.format %>%
   subset_taxa(Class == "Cyanobacteria")
   

WE2v12 <- subset_samples(cyanos.noscale, Station %in% c("nearshore", "Toledo"))

g1 <- 
make_station_bray_heatmap(
  physeq = WE2v12, 
  range = c(0,1),
  xlab = "Nearshore",
  ylab = "Toledo",
  title = "Toledo vs Nearshore"
)

g1 <- g1 + theme(legend.position = "none")

WE2v4 <- subset_samples(cyanos.noscale, Station %in% c("nearshore", "offshore") & Date != "9/29")

g2 <- 
make_station_bray_heatmap(
  physeq = WE2v4,
  range = c(0,1),
  xlab = "Offshore",
  ylab = "Nearshore",
  title = "Nearshore vs Offshore"
)

g2 <- g2 + theme(legend.position = "none")

WE4v12 <- subset_samples(cyanos.noscale, Station %in% c("offshore", "Toledo") & Date != "9/29")

g3 <- 
make_station_bray_heatmap(
  physeq = WE4v12,
  range = c(0,1),
  xlab = "Offshore",
  ylab = "Toledo",
  title = "Toledo vs Offshore"
)


g1 = ggplotGrob(g1)
g2 = ggplotGrob(g2)
g3 = ggplotGrob(g3)

g1 <- gtable_add_cols(g1, g3$widths[6])
g2 <- gtable_add_cols(g2, g3$widths[6])

#dev.off()
grid.draw(cbind(g1, g2, g3, size = "first"))





```


## S4: heterotroph site vs site bray-curtis heatmaps

```{r}
st2 <- subset_samples(erie.scale.format, Station == "nearshore")
st4 <- subset_samples(erie.scale.format, Station == "offshore")
st12 <- subset_samples(erie.scale.format, Station == "Toledo")




```


```{r fig.height=7, fig.width=22}

heteros.scale <-
   erie %>%
   subset_samples(Fraction == "CNA") %>%
   subset_taxa(Class != "Cyanobacteria") %>%
   scale_reads(round = "round") 


WE2v12 <- subset_samples(heteros.scale, Station %in% c("nearshore", "Toledo"))

g1 <- 
make_station_bray_heatmap(
  physeq = WE2v12, 
  range = c(.15,.85),
  xlab = "Nearshore",
  ylab = "Toledo",
  title = "Toledo vs Nearshore"
)

WE2v4 <- subset_samples(heteros.scale, Station %in% c("nearshore", "offshore") & Date != "9/29")

g2 <- 
make_station_bray_heatmap(
  physeq = WE2v4,
  range = c(.15,.85),
  xlab = "Offshore",
  ylab = "Nearshore",
  title = "Nearshore vs Offshore"
)

WE4v12 <- subset_samples(heteros.scale, Station %in% c("offshore", "Toledo") & Date != "9/29")

g3 <- 
make_station_bray_heatmap(
  physeq = WE4v12,
  range = c(.15,.85),
  xlab = "Offshore",
  ylab = "Toledo",
  title = "Toledo vs Offshore"
)


grid.arrange(g1, g2, g3, ncol = 3)
```

## S5: main figure 3 with alternate scaling
```{r, fig.height=7, fig.width=15}

cyanos <-
   erie.scale.format %>%
   subset_taxa(Class == "Cyanobacteria")

heterotrophs <-
  erie.scale.format %>%
  subset_taxa(Class != "Cyanobacteria")

cyanos.pcoa <- ordinate(
  physeq = cyanos, 
  method = "PCoA", 
  distance = "bray"
) 

heterotrophs.pcoa <- ordinate(
  physeq = heterotrophs, 
  method = "PCoA", 
  distance = "bray"
) 


bray.pc.htrophs <- data.frame(SampleID = rownames(heterotrophs.pcoa$vectors), PC1 = heterotrophs.pcoa$vectors[ ,1], PC2 = -1*heterotrophs.pcoa$vectors[ ,2], row.names = NULL)
bray.pc.cyanos <- data.frame(SampleID = rownames(cyanos.pcoa$vectors), PC1 = -1*cyanos.pcoa$vectors[ ,1], PC2 = cyanos.pcoa$vectors[ ,2], row.names = NULL)

braypc.htrophs.sampledata <- 
  nutrient %>%
    filter(Fraction == "CNA") %>%
    filter(Date != "8/11") %>%
    left_join(bray.pc.htrophs, by = "SampleID")  %>%
    order_dates() 

braypc.htrophs.sampledata$Station <- factor(braypc.htrophs.sampledata$Station, 
  levels = c("nearshore", "Toledo", "offshore"))


braypc1.plot <-
  ggplot(braypc.htrophs.sampledata, aes(x = Date, y = PC1, group = Station, color = Station)) +
  geom_line(size = 1.2) + 
  scale_color_manual(values = c("#E96446","#52361b","#87CEFA")) +
  xlab("") + 
  ylab("PC1 (35.4%)") +
  ggtitle("Heterotrophs") +
  theme(
    axis.text.x = element_blank(),
    axis.title.y = element_text(size = 14),
    plot.title = element_text(size = 18, face = "bold"),
    plot.margin = unit(c(1, 1.5, -0.2, 1.5), "cm"),
    legend.position = "none"
  ) 

braypc2.plot <-
  ggplot(braypc.htrophs.sampledata, aes(x = Date, y = PC2, group = Station, color = Station)) +
  geom_line(size = 1.2) + 
  scale_color_manual(values = c("#E96446","#52361b","#87CEFA")) +
  ylab("PC2 (10.8%)") + 
  xlab("") +
  theme(
    axis.text.x = element_text(
      angle = 45, 
      vjust = 1, 
      hjust = 1, 
      size = 14, 
      face = "bold"
      ), 
    axis.title.y = element_text(size = 14),
    legend.position = "none",
    plot.margin = unit(c(-0.2, 1.5, 1, 1.5), "cm")
  )

braypc.cyanos.sampledata <- 
  nutrient %>%
    filter(Fraction == "CNA") %>%
    filter(Date != "8/11") %>%
    left_join(bray.pc.cyanos, by = "SampleID")  %>%
    order_dates() 

braypc.cyanos.sampledata$Station <- factor(braypc.cyanos.sampledata$Station, 
  levels = c("nearshore", "Toledo", "offshore"))


braypc3.plot <-
  ggplot(braypc.cyanos.sampledata, aes(x = Date, y = PC1, group = Station, color = Station)) +
  geom_line(size = 1.2) + 
  scale_color_manual(values = c("#E96446","#52361b","#87CEFA")) +
  xlab("") + 
  ylab("PC1 (19.0%)") +
  ggtitle("Cyanobacteria") +
  theme(
    axis.text.x = element_blank(),
    axis.title.y = element_text(size = 14),
    plot.margin = unit(c(1, 1.5, -0.2, 1.5), "cm"),
    plot.title = element_text(size = 18, face = "bold"),
    legend.position = "bottom"
  ) 

legend <- gtable_filter(ggplot_gtable(ggplot_build(braypc3.plot)), "guide-box") 

braypc3.plot <- braypc3.plot + guides(color = FALSE)

braypc4.plot <-
  ggplot(braypc.cyanos.sampledata, aes(x = Date, y = PC2, group = Station, color = Station)) +
  geom_line(size = 1.2) + 
  scale_color_manual(values = c("#E96446","#52361b","#87CEFA")) +
  ylab("PC2 (14.4%)") + 
  xlab("") +
  theme(
    axis.text.x = element_text(
      angle = 45, 
      vjust = 1, 
      hjust = 1, 
      size = 14, 
      face = "bold"
      ), 
    axis.title.y = element_text(size = 14),
    legend.position = "none",
    plot.margin = unit(c(-0.2, 1.5, 1, 1.5), "cm")
  )

g1 = ggplotGrob(braypc1.plot)
g2 = ggplotGrob(braypc2.plot)
g3 = ggplotGrob(braypc3.plot)
g4 = ggplotGrob(braypc4.plot)


ggdraw() +
  draw_plot(rbind(g3, g4, size = "first"), x = 0.01, y = 0.1, width = .48, height = .88) +
  draw_plot(rbind(g1, g2, size = "first"), x = 0.51, y = 0.1, width = .48, height = .88) +
  draw_plot(legend, x = .47, y = 0.05, width = .1, height = .05) + 
  draw_plot_label(c("A", "B"), c(0.02, 0.49), c(1, 1), size = 20) 
 
```

**Figure Legend:** This is the same plot as main figure 3, but instead of scaling the abundance of each OTU internally to the Cyanobacteria or 
Heterotrophic community, abundance was kept as a fraction of the total reads from all bacteria in a sample

     
## S6: Phylum composition of full community across sites

```{r composition barplot, echo = FALSE, fig.height = 10, fig.width = 14}
# Subset to full community,
# Transform to long format and prune out phyla below 2% in each sample
# for easier to read stacked barplot
erie.811 <-
  mothur.merge %>%
  subset_taxa(Kingdom == "Bacteria" &
                Family  != "mitochondria" &
                Class   != "Chloroplast"
                ) %>%
    subset_samples(Type == "sample") %>%
    subset_samples(!(Date %in% c ("5/27", "6/10", "11/3")))

erie.811 <- prune_taxa(taxa_sums(erie.811) > 0, erie.811)

Full.long <-
    erie.811 %>%
      subset_samples(Fraction == "CNA") %>%
      taxglom_and_melt(taxrank = "Phylum", prune = 0.02) %>%
      mutate(Station = revalue(Station, c('WE2' = 'nearshore', 'WE12' = 'Toledo', 'WE4' = 'offshore'))) %>%
      habs_format() 
      

# Set colors for plotting
phylum.colors <- c(
  "#CBD588", "#5F7FC7", "orange","#DA5724", "#508578", "#CD9BCD",
   "#AD6F3B", "#673770","#D14285", "#652926", "#C84248", 
  "#8569D5", "#5E738F","#D1A33D", "#8A7C64", "#599861"
)


# Plot 
ggplot(Full.long, aes(x = Date, y = Abundance, fill = Phylum)) + 
  facet_grid(Station~., scales = "free_y") +
  geom_bar(stat = "identity") +
  geom_bar(
    stat = "identity", 
    position = "fill", 
    colour = "black", 
    show_guide = FALSE
  ) + 
  scale_fill_manual(values = phylum.colors) +
  stackbar_theme +
  guides(fill = guide_legend(reverse = TRUE, keywidth = 1, keyheight = 1)) +
  xlab("") +
  ylab("Relative Abundance (Phyla > 2%) \n") 
        
```


