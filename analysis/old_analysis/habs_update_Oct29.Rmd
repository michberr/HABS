  
---
title: 'Lake Erie HABs Community Manuscript'
output:
  html_document:
    toc: true
---
    



```{r global_options, include=FALSE}

knitr::opts_chunk$set(
  fig.width = 6, 
  fig.height = 5, 
  fig.align = 'center', 
  fig.path = 'Figs/',
  echo = FALSE, 
  warning = FALSE, 
  message = FALSE
)

```


```{r load libraries}

#Load libraries
setwd("~/chabs/miseq_may2015/analysis")
library(phyloseq)
library(ggplot2)
library(dplyr)
library(scales)
library(grid)
library(reshape2)
library(gridExtra)
library(RColorBrewer)
library(vegan)
library(car)
library(magrittr)
library(knitr)
source("habs_functions.R")
source("~/git_repos/MicrobeMiseq/R/miseqR.R")
theme_set(theme_bw())
```

 # Sample summary
```{r mothur import, echo = FALSE}

# Import mothur files and sample metadata
sharedfile = "mothur/allhabs.shared"
taxfile = "mothur/allhabs.taxonomy"
mapfile = "other/habs_metadata.csv"

mothurdata = import_mothur(mothur_shared_file = sharedfile, 
	mothur_constaxonomy_file = taxfile)

# Add the OTU number as a column in the taxonomy file
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
	rownames(tax_table(mothurdata)))

# Rename the taxonomy columns
colnames(tax_table(mothurdata)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")
  
# Import sample metadata and transform into sample_data class
map <- read.csv(mapfile)

# Recode Station
map$Station <- recode(
  map$Station, 
  "'WE2' = 'nearshore'; 
  'WE12' = 'Toledo'; 
  'WE4' = 'offshore'"
)

# Add shore as a variable
map <-
  map %>% 
    mutate(Shore = as.factor(ifelse(Station == "nearshore" | Station == "Toledo", "nearshore",
                          ifelse(Station == "offshore", "offshore", NA)))
           )


# Convert map to sample_data class
# Merge mothurdata object with sample_data
map <- sample_data(map)
rownames(map) <- map$SampleID
mothur.merge <- merge_phyloseq(mothurdata, map)
  

# Filter out non-samples (i.e. water, mock) and samples from intensive cruises.
erie <-
  mothur.merge %>%
    subset_taxa(
      Kingdom == "Bacteria" &
      Family != "mitochondria" &
      Class != "Chloroplast"
    ) %>%
    subset_samples(
      Type == "sample" & 
      !(Date %in% c("5/27", "6/10", "8/11", "11/3"))
    )
    

# Also prune out taxa which were only present in removed samples
erie <- prune_taxa(taxa_sums(erie) > 0, erie)

erie


```

# Alpha Diversity dynamics

estimate OTU richness and evenness for the full community samples. 
```{r}
Full <-
  erie %>%
  subset_samples(Fraction == "CNA")

min(sample_sums(Full))

```
Since our minimum library size is 15,631, we will subsample to 15,000 reads. 
We will repeat this 100 times and average the diversity estimates from each trial. 

```{r, cache=TRUE}
# Initialize matrices to store richness and evenness estimates
nsamp = nsamples(Full)
trials = 100

richness <- matrix(nrow = nsamp, ncol = trials)
row.names(richness) <- sample_names(Full)

evenness <- matrix(nrow = nsamp, ncol = trials)
row.names(evenness) <- sample_names(Full)

# It is always important to set a seed when you subsample so your result is replicable 
set.seed(3)

for (i in 1:100) {
  # Subsample
  r <- rarefy_even_depth(Full, sample.size = 15000, verbose = FALSE, replace = TRUE)
  
  # Calculate richness
  rich <- as.numeric(as.matrix(estimate_richness(r, measures = "Observed")))
  richness[ ,i] <- rich
  
  # Calculate evenness
  even <- as.numeric(as.matrix(estimate_richness(r, measures = "InvSimpson")))
  evenness[ ,i] = even
}

# Create a new dataframe to hold the means and standard deviations of richness estimates
SampleID <- row.names(richness)
mean <- apply(richness, 1, mean)
sd <- apply(richness, 1, sd)
measure <- rep("Observed Richness", nsamp)
rich.stats <- data.frame(SampleID, mean, sd, measure)

# Create a new dataframe to hold the means and standard deviations of evenness estimates
SampleID <- row.names(evenness)
mean <- apply(evenness, 1, mean)
sd <- apply(evenness, 1, sd)
measure <- rep("Inverse Simpson", nsamp)
even.stats <- data.frame(SampleID, mean, sd, measure)


alpha <- rbind(rich.stats, even.stats)
```

```{r}
s <- data.frame(sample_data(Full))

alphadiv <- 
  s %>%
    merge(alpha, by = "SampleID") %>%
    order_dates() 
    

```

Finally, we will plot the two alpha diversity measures in a timeseries using a facet

```{r fig.height=10, fig.width=10}

theme_set(theme_classic())

ggplot(alphadiv, 
  aes(x = Date, 
      y = mean, 
      color = Station, 
      group = Station, 
      shape = Station
  )
) +
  geom_point(size = 2) + 
  geom_line(size = 0.8) +
  facet_wrap(~measure, ncol = 1, scales = "free") +
  ylab("Reads (depth = 15000)") +
  xlab("") +
  ggtitle("") +
  scale_color_manual(values = c("#E96446", "#302F3D", "#87CEFA")) +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 10, face = "bold"),
    plot.margin = unit(c(0, 0, 1, 0), "lines"),
    strip.background = element_rect(color = "white"),
    strip.text = element_text(face = "bold", size = 14),
    panel.margin = unit(1, "lines")
  )

```
     
# Beta Diversity dynamics 

notes: I need to figure out a way to interpolate temperature and maybe other variables

## Bioenv
```{r echo = FALSE}

# Scale reads to even depth 
Full.scale.format <-
  erie %>%
    subset_samples(Fraction == "CNA") %>%
    scale_reads(round = "round") %>%
    refactor_months_and_stations() 


### Bioenv #######
data.frame(sample_data(Full.scale.format)) %>%
  select(pH, Temp, Turbidity, SRP, POC,
         Nitrate, Ammonia, H2O2, Chla, ParMC, Phycocyanin) %>%
  na.omit() -> env



# Calculate bray-curtis distance
Full.scale.format %>%
  phyloseq::distance(method = "bray") -> full.bray

# remove NA's from bray dist object
full.bray <- as.matrix(full.bray)
bray.sub <- full.bray[rownames(env), rownames(env)]
bray.sub <- as.dist(bray.sub)

# Run bioenv analysis
b <- bioenv(bray.sub, env, method = "spearman", trace = T, upto = 12)

summary(b)

# Select best variables from env
env %>%
  select(pH, Temp, Turbidity) -> env.subset

# Scale env variables and calculate euclidean distance
env.scale <- scale(env.subset)
env.dist <- dist(env.scale, method = "euclidean")
```
      
The best model is with three variables: Turbidity, temperature, and pH. I ran a mantel test examining the spearman correlation between
the bray-curtis dissimilarity of the samples and the euclidean distance of these three variables


```{r}
# Run partial mantel 
mantel(bray.sub, env.dist, method = "spearman")
```

Something about this makes me really uncomfortable because this is time series data. I believe jed furhmans lab used a vector for time in a partial mantel. I could try to find the the number of lags that a point seems to depend on and include that in the model. To be discussed.

## Ordinations 

```{r echo = FALSE, fig.height = 8, fig.width = 20}

# Ordinate
Full.pcoa <- ordinate(
  physeq = Full.scale.format, 
  method = "PCoA", 
  distance = "bray"
)

# Plot 
PCoA <-
plot_ordination(
  physeq = Full.scale.format,
  ordination = Full.pcoa,
  color = "Month",
  shape = "Station",
  title = "PCoA analysis"
) + 
  scale_color_manual(values = c("red", "#ffae19", "#4daf4a", 
		"#1919ff", "darkorchid3", "black")
  ) +
  geom_point(aes(color = Month), alpha = 0.6, size = 6) +
  geom_point(colour = "grey90", size = 2) 


# Plot with species as biplot
PCoA <-
plot_ordination(
  physeq = CNA.scale.prune,
  ordination = Full.pcoa,
  type = "biplot",
  title = "PCoA analysis"
) 

# Filter out ones that lie east of .1
bloom_heteros <- 
  PCoA$data %>%
    filter(Axis.1 > 0.1)



# Remove data points with missing metadata
Full.sub <- subset_samples(Full.scale.format,
  !is.na(Turbidity) &
  !is.na(Temp) &
  !is.na(pH) 
)

bdist <- phyloseq::distance(physeq = Full.sub, method = "bray")

							
# CAP ordinate
cap.ord <- ordinate(
	physeq = Full.sub, 
	method = "CAP",
	distance = bdist,
	formula = ~Turbidity +  pH + Temp 
)

# How to reflect scores on CAP2? 
cap.plot <- plot_ordination(
	Full.scale.format, 
	cap.ord, 
	color = "Month", 
	axes = c(1,2)
	) + 
	aes(shape = Station) + 
	geom_point(
	  aes(colour = Month), 
		alpha = 0.6, 
		size = 6
	) + 
	geom_point(
	  colour = "grey90", 
		size = 2
	) + 
	scale_color_manual(values = c("red", "#ffae19", "#4daf4a", 
		"#1919ff", "darkorchid3")) +
  scale_y_reverse(limits = c(1.5, -1.5))


# Now add the environmental variables as arrows
arrowmat <- vegan::scores(cap.ord, display = "bp")

# Add labels, make a data.frame
arrowdf <- data.frame(labels = rownames(arrowmat), arrowmat)

# Define the arrow aesthetic mapping
arrow_map <- aes(xend = CAP1, 
	yend = CAP2, 
	x = 0, 
	y = 0, 
	shape = NULL, 
	color = NULL, 
	label = labels)

label_map <- aes(x = 1.3 * CAP1, 
	y = 1.3 * CAP2, 
	shape = NULL, 
	color = NULL, 
	label = labels)

arrowhead = arrow(length = unit(0.02, "npc"))

# Make a new graphic
CAP <-
cap.plot + 
geom_segment(arrow_map, 
	size = .5, 
	data = arrowdf, 
	color = "gray", 
	arrow = arrowhead
	) + 
geom_text(label_map, 
	size = 4, face = "bold", 
	data = arrowdf, 
	show_guide = FALSE) +
ggtitle("CAP analysis")


grid.arrange(PCoA, CAP, nrow = 1, ncol = 2)


```

## PERMANOVA
```{r echo = FALSE}
# Remove dates for which we are missing samples for any of the sites
stations.date <- subset_samples(Full.scale.format, Date != "9/29")

```


Adonis test for all three Stations. Note: i removed dates from this analysis where samples were missing from 
any of the three sites
```{r echo = FALSE}
station.adonis <- 
  phyloseq_to_adonis(
    physeq = stations.date, 
    dist = "bray", 
    formula = "Shore + Station"
  ) 


```

# Cyanobacteria OTU dynamics

```{r}

thresh = 0.0001
n = 15000

CNA.scale <-
  erie %>%
  subset_samples(Fraction == "CNA") %>%
  scale_reads(n =  n, round = "round") 


# Prune low abundance taxa
tax_mean <- taxa_sums(CNA.scale)/nsamples(CNA.scale)
CNA.scale.prune <- prune_taxa(tax_mean > thresh*n, CNA.scale)

# Cyanobacteria: subset and separate otu table
cyanos <-
  CNA.scale.prune %>%
  subset_taxa(Class == "Cyanobacteria") 
  
 

```

## Station 2

```{r}

# Subset to WE2
cyanos.we2 <- 
  cyanos %>%
    subset_samples(Station == "nearshore")

```

```{r fig.height = 12, fig.width = 16}


##################### Z-score scale (no log scaling) ##############

cyanos.we2.scale <- 
  cyanos.we2 %>%
    scale_otu(taxrank = "Genus")  
    
cyanos.we2.scale.df <-
  cyanos.we2.scale %>%
    data.frame() %>%
    mutate(Date = row.names(cyanos.we2.scale)) %>%
    melt() %>%
    order_dates()

g1 <-
ggplot(cyanos.we2.scale.df, aes(x = Date, y = value, group = variable, color = variable)) +
  geom_line(stat = "identity") +
  facet_grid(variable~.) + 
  theme(
      axis.text.x = element_text(
        angle = 45, 
        vjust = 1, 
        hjust = 1, 
        size = 9, 
        face = "bold"
        ),   
      strip.text = element_blank(),
      strip.background = element_blank(),
      axis.title.y = element_text(size = 14),
      plot.title = element_text(size = 16, face = "bold")
    ) + ggtitle("z-score scaling") + guides(color = FALSE)

cyanos.we2.scale <- heat_wrapper(
  physeq = cyanos.we2, 
  taxrank = "Genus",
  dist.method = "spearman",
  k = 3
)


cyanos.we2.logscale <- 
  cyanos.we2 %>%
    scale_otu_log(taxrank = "Genus")  
    
cyanos.we2.logscale.df <-
  cyanos.we2.logscale %>%
    data.frame() %>%
    mutate(Date = row.names(cyanos.we2.logscale)) %>%
    melt() %>%
    order_dates()


g2 <- 
  ggplot(cyanos.we2.logscale.df, aes(x = Date, y = value, group = variable, color = variable)) +
  geom_line(stat = "identity") +
  facet_grid(variable~.) +
  theme(
    axis.text.x = element_text(
      angle = 45, 
      vjust = 1, 
      hjust = 1, 
      size = 9, 
      face = "bold"
      ), 
    strip.text = element_blank(),
    strip.background = element_blank(),
    axis.title.y = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold")
  ) + ggtitle("log-scaling & z-score scaling")

grid.arrange(g1, g2, ncol = 2, widths = c(1, 1.5))
```

```{r fig.height = 6, fig.width = 16}
# Make heatmap
otulabs.colors <- brewer.pal(n = 4, name = "Dark2")


g1 <-
ggplot(cyanos.we2.scale$data, aes(x = Date, y = OTU) ) +
  geom_tile(aes(fill = value)) +
  scale_fill_gradient(low = "#000033", high = "#FF3300") +
  theme(
    axis.text.x = element_text(
      angle = 45, 
      vjust = 1, 
      hjust = 1, 
      size = 9, 
      face = "bold"
      ),     
    axis.title.y = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold"),
    axis.text.y = element_text(
      color =  otulabs.colors[cyanos.we2.scale$clusters]
    )
  ) + 
  ggtitle("z-score scaling")


cyanos.we2.logscale <- heat_log_wrapper(
   physeq = cyanos.we2, taxrank = "Genus", dist.method = "euclidean", k = 3
)

otulabs.colors <- brewer.pal(n = 4, name = "Dark2")

g2 <-
ggplot(cyanos.we2.logscale$data, aes(x = Date, y = OTU) ) +
  geom_tile(aes(fill = value)) +
  scale_fill_gradient(low = "#000033", high = "#FF3300") +
  theme(
    axis.text.x = element_text(
      angle = 45, 
      vjust = 1, 
      hjust = 1, 
      size = 9, 
      face = "bold"
      ),     
    axis.title.y = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold"),
    axis.text.y = element_text(
      color =  otulabs.colors[cyanos.we2.logscale$clusters]
    )
  ) +
  ggtitle("log-scaling & z-score scaling")

grid.arrange(g1, g2, ncol = 2)

```




## Station 12
```{r echo = FALSE}

# WE 12
cyanos.we12 <- 
  cyanos %>%
  subset_samples(Station == "Toledo") 
```


```{r fig.height = 12, fig.width = 16}


##################### Z-score scale (no log scaling) ##############

cyanos.we12.scale <- 
  cyanos.we12 %>%
    scale_otu(taxrank = "Genus")  
    
cyanos.we12.scale.df <-
  cyanos.we12.scale %>%
    data.frame() %>%
    mutate(Date = row.names(cyanos.we12.scale)) %>%
    melt() %>%
    order_dates()

g1 <-
ggplot(cyanos.we12.scale.df, aes(x = Date, y = value, group = variable, color = variable)) +
  geom_line(stat = "identity") +
  facet_grid(variable~.) + 
  theme(
      axis.text.x = element_text(
        angle = 45, 
        vjust = 1, 
        hjust = 1, 
        size = 9, 
        face = "bold"
        ),   
      strip.text = element_blank(),
      strip.background = element_blank(),
      axis.title.y = element_text(size = 14),
      plot.title = element_text(size = 16, face = "bold")
    ) + ggtitle("z-score scaling") + guides(color = FALSE)

cyanos.we12.scale <- heat_wrapper(
  physeq = cyanos.we12, 
  taxrank = "Genus",
  dist.method = "spearman",
  k = 3
)


cyanos.we12.logscale <- 
  cyanos.we12 %>%
    scale_otu_log(taxrank = "Genus")  
    
cyanos.we12.logscale.df <-
  cyanos.we12.logscale %>%
    data.frame() %>%
    mutate(Date = row.names(cyanos.we12.logscale)) %>%
    melt() %>%
    order_dates()


g2 <- 
  ggplot(cyanos.we12.logscale.df, aes(x = Date, y = value, group = variable, color = variable)) +
  geom_line(stat = "identity") +
  facet_grid(variable~.) +
  theme(
    axis.text.x = element_text(
      angle = 45, 
      vjust = 1, 
      hjust = 1, 
      size = 9, 
      face = "bold"
      ), 
    strip.text = element_blank(),
    strip.background = element_blank(),
    axis.title.y = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold")
  ) + ggtitle("log-scaling & z-score scaling")

grid.arrange(g1, g2, ncol = 2, widths = c(1, 1.5))
```

```{r fig.height = 6, fig.width = 16}
# Make heatmap
otulabs.colors <- brewer.pal(n = 4, name = "Dark2")


g1 <-
ggplot(cyanos.we12.scale$data, aes(x = Date, y = OTU) ) +
  geom_tile(aes(fill = value)) +
  scale_fill_gradient(low = "#000033", high = "#FF3300") +
  theme(
    axis.text.x = element_text(
      angle = 45, 
      vjust = 1, 
      hjust = 1, 
      size = 9, 
      face = "bold"
      ),     
    axis.title.y = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold"),
    axis.text.y = element_text(
      color =  otulabs.colors[cyanos.we12.scale$clusters]
    )
  ) + 
  ggtitle("z-score scaling")


cyanos.we12.logscale <- heat_log_wrapper(
   physeq = cyanos.we12, taxrank = "Genus", dist.method = "euclidean", k = 3
)

otulabs.colors <- brewer.pal(n = 4, name = "Dark2")

g2 <-
ggplot(cyanos.we12.logscale$data, aes(x = Date, y = OTU) ) +
  geom_tile(aes(fill = value)) +
  scale_fill_gradient(low = "#000033", high = "#FF3300") +
  theme(
    axis.text.x = element_text(
      angle = 45, 
      vjust = 1, 
      hjust = 1, 
      size = 9, 
      face = "bold"
      ),     
    axis.title.y = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold"),
    axis.text.y = element_text(
      color =  otulabs.colors[cyanos.we12.logscale$clusters]
    )
  ) +
  ggtitle("log-scaling & z-score scaling")

grid.arrange(g1, g2, ncol = 2)

```



## Station 4
```{r echo = FALSE}

# WE 4
cyanos.we4 <- 
  cyanos %>%
  subset_samples(Station == "offshore")

```

```{r fig.height = 12, fig.width = 16}


##################### Z-score scale (no log scaling) ##############

cyanos.we4.scale <- 
  cyanos.we4 %>%
    scale_otu(taxrank = "Genus")  
    
cyanos.we4.scale.df <-
  cyanos.we4.scale %>%
    data.frame() %>%
    mutate(Date = row.names(cyanos.we4.scale)) %>%
    melt() %>%
    order_dates()

g1 <-
ggplot(cyanos.we4.scale.df, aes(x = Date, y = value, group = variable, color = variable)) +
  geom_line(stat = "identity") +
  facet_grid(variable~.) + 
  theme(
      axis.text.x = element_text(
        angle = 45, 
        vjust = 1, 
        hjust = 1, 
        size = 9, 
        face = "bold"
        ),   
      strip.text = element_blank(),
      strip.background = element_blank(),
      axis.title.y = element_text(size = 14),
      plot.title = element_text(size = 16, face = "bold")
    ) + ggtitle("z-score scaling") + guides(color = FALSE)

cyanos.we4.scale <- heat_wrapper(
  physeq = cyanos.we4, 
  taxrank = "Genus",
  dist.method = "spearman",
  k = 3
)


cyanos.we4.logscale <- 
  cyanos.we4 %>%
    scale_otu_log(taxrank = "Genus")  
    
cyanos.we4.logscale.df <-
  cyanos.we4.logscale %>%
    data.frame() %>%
    mutate(Date = row.names(cyanos.we4.logscale)) %>%
    melt() %>%
    order_dates()


g2 <- 
  ggplot(cyanos.we4.logscale.df, aes(x = Date, y = value, group = variable, color = variable)) +
  geom_line(stat = "identity") +
  facet_grid(variable~.) +
  theme(
    axis.text.x = element_text(
      angle = 45, 
      vjust = 1, 
      hjust = 1, 
      size = 9, 
      face = "bold"
      ), 
    strip.text = element_blank(),
    strip.background = element_blank(),
    axis.title.y = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold")
  ) + ggtitle("log-scaling & z-score scaling")

grid.arrange(g1, g2, ncol = 2, widths = c(1, 1.5))
```

```{r fig.height = 6, fig.width = 16}
# Make heatmap
otulabs.colors <- brewer.pal(n = 4, name = "Dark2")


g1 <-
ggplot(cyanos.we4.scale$data, aes(x = Date, y = OTU) ) +
  geom_tile(aes(fill = value)) +
  scale_fill_gradient(low = "#000033", high = "#FF3300") +
  theme(
    axis.text.x = element_text(
      angle = 45, 
      vjust = 1, 
      hjust = 1, 
      size = 9, 
      face = "bold"
      ),     
    axis.title.y = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold"),
    axis.text.y = element_text(
      color =  otulabs.colors[cyanos.we4.scale$clusters]
    )
  ) + 
  ggtitle("z-score scaling")


cyanos.we4.logscale <- heat_log_wrapper(
   physeq = cyanos.we4, taxrank = "Genus", dist.method = "euclidean", k = 3
)

otulabs.colors <- brewer.pal(n = 4, name = "Dark2")

g2 <-
ggplot(cyanos.we4.logscale$data, aes(x = Date, y = OTU) ) +
  geom_tile(aes(fill = value)) +
  scale_fill_gradient(low = "#000033", high = "#FF3300") +
  theme(
    axis.text.x = element_text(
      angle = 45, 
      vjust = 1, 
      hjust = 1, 
      size = 9, 
      face = "bold"
      ),     
    axis.title.y = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold"),
    axis.text.y = element_text(
      color =  otulabs.colors[cyanos.we4.logscale$clusters]
    )
  ) +
  ggtitle("log-scaling & z-score scaling")

grid.arrange(g1, g2, ncol = 2)

```




# Autocorrelation lag

## Cyanos

### WE2
```{r, fig.height=10, fig.width=12}

cyanos.we2.scale <- 
  cyanos.we2 %>%
    scale_otu(taxrank = "Genus")

par(mfrow = c(3,4))
for (i in 1:11) {
  title = colnames(cyanos.we2.scale)[i]
  acf(cyanos.we2.scale[ ,i], main = title)
}
```

### WE12
```{r, fig.height=10, fig.width=12}
cyanos.we12.scale <- 
  cyanos.we12 %>%
    scale_otu(taxrank = "Genus")

par(mfrow = c(3,4))
for (i in 1:11) {
  title = colnames(cyanos.we2.scale)[i]
  acf(cyanos.we12.scale[ ,i],  main = title)
}
```

### WE4
```{r, fig.height=10, fig.width=12}
cyanos.we4.scale <- 
  cyanos.we4 %>%
    scale_otu(taxrank = "Genus")

par(mfrow = c(3,4))
for (i in 1:11) {
  title = colnames(cyanos.we2.scale)[i]
  acf(cyanos.we4.scale[ ,i], main = title)
}

```

There is no generally no autocorrelation lag for cyanobacteria OTUs

## Heterotrophs
```{r}
heteros <-
  CNA.scale.prune %>%
  subset_taxa(Class != "Cyanobacteria") 
```

## WE2
```{r fig.height=12, fig.width=14}
heteros.we2 <- subset_samples(heteros, Station == "nearshore")

heteros.we2.scale <- 
  heteros.we2 %>%
    scale_otu(taxrank = "Genus")

par(mfrow = c(4,5))
for (i in 1:20) {
  acf(heteros.we2.scale[ ,i])
}

```

```{r fig.height=10, fig.width=12}

par(mfrow = c(4,5))
for (i in 21:40) {
  acf(heteros.we2.scale[ ,i])
}

```

There are slightly more heterotrophs that show a one week lag than cyanobacteria . . . how to statistically show this? Would have to account for multiple hypotheses


# Timelags

```{r}
st2 <- subset_samples(Full.scale.format, Station == "nearshore")
st4 <- subset_samples(Full.scale.format, Station == "offshore")
st12 <- subset_samples(Full.scale.format, Station == "Toledo")


make_station_bray_heatmap <- function(physeq, self = FALSE, range, xlab, ylab, title) {
  
 
  # Calculate bray
  braydist <- as.matrix(phyloseq::distance(physeq, method = "bray"))
  
  # rows will be evens columns will be odds
  if (!self) {
    rows <- seq(from = 2, to = ncol(braydist), by = 2)
    cols <- seq(from = 1, to = ncol(braydist), by = 2)
    braydist <- braydist[rows, cols]
  }
 
  
  
  # rename the columns by date instead of sample number
  colnames(braydist) <- unique(sample_data(physeq)$Date)
  rownames(braydist) <- unique(sample_data(physeq)$Date)
  
  # Melt
  station.bray.melt <- melt(braydist, varnames = c("st1", "st2"))
  
  
  # ggplot
  g <- ggplot(station.bray.melt, aes(x = st1, y = st2) ) +
  geom_tile(aes(fill = value)) + 
  theme(
    axis.text.x = element_text(
      size = 10, 
      face = "bold"
      ),  
    axis.text.y = element_text(face = "bold"),
    axis.title.y = element_text(size = 16, face = "bold"),
    axis.title.x = element_text(size = 16, face = "bold")
  ) + 
  xlab(xlab) +
  ylab(ylab) + 
  ggtitle(title)
  
  if (!self) {
    g = g + scale_fill_gradient(low = "red", high = "white", limits = range)
  } else {
    g = g + scale_fill_gradient(low = "blue", high = "white", limits = range)
  }
  
  
}

```







# Bray Heatmaps
```{r fig.height=12, fig.width=22}

WE2v12 <- subset_samples(Full.scale.format, Station %in% c("nearshore", "Toledo"))
g1 <- 
make_station_bray_heatmap(
  physeq = WE2v12, 
  range = c(.15,.85),
  xlab = "Nearshore",
  ylab = "Toledo",
  title = "Toledo vs Nearshore"
)

WE2v4 <- subset_samples(Full.scale.format, Station %in% c("nearshore", "offshore") & Date != "9/29")

g2 <- 
make_station_bray_heatmap(
  physeq = WE2v4,
  range = c(.15,.85),
  xlab = "Offshore",
  ylab = "Nearshore",
  title = "Nearshore vs Offshore"
)

WE4v12 <- subset_samples(Full.scale.format, Station %in% c("offshore", "Toledo") & Date != "9/29")

g3 <- 
make_station_bray_heatmap(
  physeq = WE4v12,
  range = c(.15,.85),
  xlab = "Offshore",
  ylab = "Toledo",
  title = "Toledo vs Offshore"
)


WE2 <- subset_samples(Full.scale.format, Station == "nearshore")
g4 <- make_station_bray_heatmap(
  physeq = WE2,
  self = TRUE,
  range = c(0,.82),
  xlab = "Nearshore",
  ylab = "Nearshore",
  title = "Nearshore"
)

WE12 <- subset_samples(Full.scale.format, Station == "Toledo")
g5 <- make_station_bray_heatmap(
  physeq = WE12,
  self = TRUE,
  range = c(0,.82),
  xlab = "Toledo",
  ylab = "Toledo",
  title = "Toledo"
)

WE4 <- subset_samples(Full.scale.format, Station == "offshore")
g6 <- make_station_bray_heatmap(
  physeq = WE4,
  self = TRUE,
  range = c(0,.82),
  xlab = "Offshore",
  ylab = "Offshore",
  title = "Offshore"
)

grid.arrange(g1, g2, g3, g4, g5, g6, ncol = 3)

```

```{r}

mantel_bray_env <- function(physeq, env.var) {
  
  # Select env variable from sample_data
  var.physeq <- data.frame(sample_data(physeq)[ ,env.var])
  w <- which(is.na(var.physeq))
  if (length(w) > 0) {
    var.physeq <- var.physeq[-w, ] 
  }
  
  
  # Calculate euclidean distance
  d <- as.matrix(dist(var.physeq, method = "euclidean"))
  rows <- seq(from = 2, to = nrow(d), by = 2)
  cols <- seq(from = 1, to = ncol(d), by = 2)
  var.dist <- d[rows, cols]                               

  # Calculate bray curtis distance
  braydist.station <- as.matrix(
    phyloseq::distance(
      physeq, 
      method = "bray"
    )
  )
  
  if (length(w) > 0) {
     braydist.station <- braydist.station[-w, -w] 
  }
 
  rows <- seq(from = 2, to = ncol(braydist.station), by = 2)
  cols <- seq(from = 1, to = ncol(braydist.station), by = 2)
  braydist.station <- braydist.station[rows, cols]

  print(mantel(braydist.station, var.dist))
}
```

## Mantel tests
```{r echo = TRUE}
mantel_bray_env(physeq = WE2v4, "pH") # r = .64

mantel_bray_env(physeq = WE2v12, "pH")  # r = .34

mantel_bray_env(physeq = WE4v12, "pH") # r = .67

mantel_bray_env(physeq = WE2v4, "Turbidity") # r = .576

mantel_bray_env(physeq = WE2v12, "Turbidity")  # r = .35

mantel_bray_env(physeq = WE4v12, "Turbidity") # r = .52

mantel_bray_env(physeq = WE2v4, "Temp") # r = .47

mantel_bray_env(physeq = WE2v12, "Temp") # ns

mantel_bray_env(physeq = WE4v12, "Temp") # r = .5

```

## Heterotroph heatmaps; scaled internally 
```{r fig.height=12, fig.width=22}

heteros.scale <-
   erie %>%
   subset_samples(Fraction == "CNA") %>%
   subset_taxa(Class != "Cyanobacteria") %>%
   scale_reads(round = "round") 


WE2v12 <- subset_samples(heteros.scale, Station %in% c("nearshore", "Toledo"))

g1 <- 
make_station_bray_heatmap(
  physeq = WE2v12, 
  range = c(.15,.85),
  xlab = "Nearshore",
  ylab = "Toledo",
  title = "Toledo vs Nearshore"
)

WE2v4 <- subset_samples(heteros.scale, Station %in% c("nearshore", "offshore") & Date != "9/29")

g2 <- 
make_station_bray_heatmap(
  physeq = WE2v4,
  range = c(.15,.85),
  xlab = "Offshore",
  ylab = "Nearshore",
  title = "Nearshore vs Offshore"
)

WE4v12 <- subset_samples(heteros.scale, Station %in% c("offshore", "Toledo") & Date != "9/29")

g3 <- 
make_station_bray_heatmap(
  physeq = WE4v12,
  range = c(.15,.85),
  xlab = "Offshore",
  ylab = "Toledo",
  title = "Toledo vs Offshore"
)


WE2 <- subset_samples(heteros.scale, Station == "nearshore")
g4 <- make_station_bray_heatmap(
  physeq = WE2,
  range = c(0,.82),
  self = TRUE,
  xlab = "Nearshore",
  ylab = "Nearshore",
  title = "Nearshore"
)

WE12 <- subset_samples(heteros.scale, Station == "Toledo")
g5 <- make_station_bray_heatmap(
  physeq = WE12,
  range = c(0,.82),
  self = TRUE,
  xlab = "Toledo",
  ylab = "Toledo",
  title = "Toledo"
)

WE4 <- subset_samples(heteros.scale, Station == "offshore")
g6 <- make_station_bray_heatmap(
  physeq = WE4,
  range = c(0,.82),
  self = TRUE,
  xlab = "Offshore",
  ylab = "Offshore",
  title = "Offshore"
)

grid.arrange(g1, g2, g3, g4, g5, g6, ncol = 3)



```

## Heterotroph heatmaps; scaled to whole community
```{r fig.height=12, fig.width=22}
 
heteros.noscale <-
   Full.scale.format %>%
   subset_taxa(Class != "Cyanobacteria")
   

WE2v12 <- subset_samples(heteros.noscale, Station %in% c("nearshore", "Toledo"))

g1 <- 
make_station_bray_heatmap(
  physeq = WE2v12, 
  range = c(0.15,0.85),
  xlab = "Nearshore",
  ylab = "Toledo",
  title = "Toledo vs Nearshore"
)

WE2v4 <- subset_samples(heteros.noscale, Station %in% c("nearshore", "offshore") & Date != "9/29")

g2 <- 
make_station_bray_heatmap(
  physeq = WE2v4,
  range = c(0.15,0.85),
  xlab = "Offshore",
  ylab = "Nearshore",
  title = "Nearshore vs Offshore"
)

WE4v12 <- subset_samples(heteros.noscale, Station %in% c("offshore", "Toledo") & Date != "9/29")

g3 <- 
make_station_bray_heatmap(
  physeq = WE4v12,
  range = c(0.15,0.85),
  xlab = "Offshore",
  ylab = "Toledo",
  title = "Toledo vs Offshore"
)


WE2 <- subset_samples(heteros.noscale, Station == "nearshore")
g4 <- make_station_bray_heatmap(
  physeq = WE2,
  range = c(0,.82),
  self = TRUE,
  xlab = "Nearshore",
  ylab = "Nearshore",
  title = "Nearshore"
)

WE12 <- subset_samples(heteros.noscale, Station == "Toledo")
g5 <- make_station_bray_heatmap(
  physeq = WE12,
  range = c(0,.82),
  self = TRUE,
  xlab = "Toledo",
  ylab = "Toledo",
  title = "Toledo"
)

WE4 <- subset_samples(heteros.noscale, Station == "offshore")
g6 <- make_station_bray_heatmap(
  physeq = WE4,
  range = c(0,.82),
  self = TRUE,
  xlab = "Offshore",
  ylab = "Offshore",
  title = "Offshore"
)

grid.arrange(g1, g2, g3, g4, g5, g6, ncol = 3)
```

## Cyanos; no scale
```{r fig.height=12, fig.width=22}
 
cyanos.noscale <-
   Full.scale.format %>%
   subset_taxa(Class == "Cyanobacteria")
   

WE2v12 <- subset_samples(cyanos.noscale, Station %in% c("nearshore", "Toledo"))

g1 <- 
make_station_bray_heatmap(
  physeq = WE2v12, 
  range = c(0,1),
  xlab = "Nearshore",
  ylab = "Toledo",
  title = "Toledo vs Nearshore"
)

WE2v4 <- subset_samples(cyanos.noscale, Station %in% c("nearshore", "offshore") & Date != "9/29")

g2 <- 
make_station_bray_heatmap(
  physeq = WE2v4,
  range = c(0,1),
  xlab = "Offshore",
  ylab = "Nearshore",
  title = "Nearshore vs Offshore"
)

WE4v12 <- subset_samples(cyanos.noscale, Station %in% c("offshore", "Toledo") & Date != "9/29")

g3 <- 
make_station_bray_heatmap(
  physeq = WE4v12,
  range = c(0,1),
  xlab = "Offshore",
  ylab = "Toledo",
  title = "Toledo vs Offshore"
)


WE2 <- subset_samples(cyanos.noscale, Station == "nearshore")
g4 <- make_station_bray_heatmap(
  physeq = WE2,
  self = TRUE,
  range = c(0,1),
  xlab = "Nearshore",
  ylab = "Nearshore",
  title = "Nearshore"
)

WE12 <- subset_samples(cyanos.noscale, Station == "Toledo")
g5 <- make_station_bray_heatmap(
  physeq = WE12,
  self = TRUE,
  range = c(0,1),
  xlab = "Toledo",
  ylab = "Toledo",
  title = "Toledo"
)

WE4 <- subset_samples(cyanos.noscale, Station == "offshore")
g6 <- make_station_bray_heatmap(
  physeq = WE4,
  self = TRUE,
  range = c(0,1),
  xlab = "Offshore",
  ylab = "Offshore",
  title = "Offshore"
)

grid.arrange(g1, g2, g3, g4, g5, g6, ncol = 3)
```

## PCA       

     
PCA method to find driving OTUs
```{r PCA}

# Ordinate




#####
thresh = 0.0001
n = 15000

CNA.scale <-
  erie %>%
  subset_samples(Fraction == "CNA") %>%
  scale_reads(n =  n, round = "round") 


# Prune low abundance taxa
tax_mean <- taxa_sums(CNA.scale)/nsamples(CNA.scale)
CNA.scale.prune <- prune_taxa(tax_mean > thresh*n, CNA.scale) # 401 taxa


full.otu <- t(otu_table(CNA.scale.prune))
full.pca <- prcomp(x = full.otu)
biplot(full.pca)

tax_table(CNA.scale.prune)["Otu00005", ]
tax_table(CNA.scale.prune)["Otu00046", ]
tax_table(CNA.scale.prune)["Otu00006", ]
tax_table(CNA.scale.prune)["Otu00011", ]
tax_table(CNA.scale.prune)["Otu00002", ]
tax_table(CNA.scale.prune)["Otu00019", ]

full.sub <- subset_taxa(CNA.scale.prune, 
  rownames(tax_table(CNA.scale.prune)) %in% 
  c("Otu00005", "Otu00046", "Otu00006", "Otu00011", "Otu00002"))

tax_table(full.sub)[,"Species"] <- paste(tax_table(full.sub)[,"Genus"], tax_table(full.sub)[,"Species"])

full.sub.melt <- 
  full.sub %>%
    psmelt() %>%
    order_dates()




ggplot(full.sub.melt, aes(x = Date, y = Abundance, group = Species, fill = Species)) +
  facet_grid(Station~.) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_brewer(palette = "Set2")


full.sub.we2 <- subset_samples(full.sub, Station == "nearshore")

```

## bray-curtis OTU correlations

### WE2
```{r}

getbdist <- function(physeq) {
  bdist <- phyloseq::distance(physeq, method = "bray")
  bdist.vec <- as.matrix(bdist)[1, ]
  d <- data.frame(Date = sample_data(physeq)$Date, bdist.vec)
  return(d)
}

get.partbdist <- function(physeq) {
  bdist <- phyloseq::distance(physeq, method = "bray")
  bdist.m <- as.matrix(bdist)[ ,-1]
  dists = vector()
  for (i in 1:ncol(bdist.m)) {
    dists = c(dists, bdist.m[i,i])
  }
  d <- data.frame(Date = sample_data(physeq)$Date[-1], dists)
  return(d)
}


betadiv_timeseries <- function(physeq.scale, title) {
  physeq.2.scale <- subset_samples(physeq.scale, Station == "nearshore")
  physeq.12.scale <- subset_samples(physeq.scale, Station == "Toledo")
  physeq.4.scale <- subset_samples(physeq.scale, Station == "offshore")

  #  acf
  a.bdist.2 <- getbdist(physeq.2.scale)
  a.bdist.4 <- getbdist(physeq.4.scale)
  a.bdist.12 <- getbdist(physeq.12.scale)


  m <- merge(a.bdist.2, a.bdist.4, by = "Date", all = TRUE)
  m <- merge(a.bdist.12, m, by = "Date", all = TRUE)
  names(m) <- c("Date", "Station 12", "Station 2", "Station 4")
  m.sort <- order_dates(m)
  m.melt <- melt(m.sort, id.vars = "Date")
  names(m.melt) <- c("Date", "Station", "Bray-Curtis from t1")

  # CNA pacf
  p.bdist.2 <- get.partbdist(physeq.2.scale)
  p.bdist.4 <- get.partbdist(physeq.4.scale)
  p.bdist.12 <- get.partbdist(physeq.12.scale)


  p.m <- merge(p.bdist.2, p.bdist.4, by = "Date", all = TRUE)
  p.m <- merge(p.bdist.12, p.m, by = "Date", all = TRUE)
  names(p.m) <- c("Date","Station 12","Station 2","Station 4")
  p.m.sort <- order_dates(p.m)
  p.m.melt <- melt(p.m.sort, id.vars = "Date")
  names(p.m.melt) <- c("Date", "Station", "Bray-Curtis from previous timepoint")

  m.melt.merge <- merge(m.melt, p.m.melt, by.x = c("Date", "Station"), by.y = c("Date", "Station"), all = TRUE)

  melty <- melt(m.melt.merge, id.vars = c("Date", "Station"))
  names(melty) <- c("Date", "Station", "BrayType", "Dist")
  
  return(melty)
}




h <- betadiv_timeseries(heteros.scale, "")

## GGPLOT
  ggplot(h, aes(x = Date, y = Dist, group = Station, color = Station)) + 
    facet_wrap(~BrayType, ncol = 1) +
    geom_line() + 
    ylim(0, 1) +
    ylab("") +
    xlab("") +
    ggtitle("") +
    scale_color_brewer(palette = "Set1") +
    theme(
      axis.text.x = element_text(angle = 30, colour = "black", vjust = 1, hjust = 1, size = 10),
      strip.text.x = element_text(size = 14),
      strip.text.y = element_text(size = 14)
    )
  
  
function(htroph.df, cyano.df, i, physeq.scale){
  corr <- corr.test(cyano.df, htroph.df, use = "everything", method = "pearson",adjust = "fdr")
  
  pvalue <- corr$p
  r <- corr$r
  
  sig <- which(pvalue < 0.05)
  otu.names <- colnames(pvalue)[sig]
  
  sig.tax <- data.frame(tax_table(physeq.scale))[otu.names,]
  sig.p <- pvalue[sig]
  sig.r <- r[sig]
  sig.dat <- data.frame(sig.p, sig.r, sig.tax)
  names(sig.dat)[1:2] <- c("pvalue", "r")
  sig.dat <- arrange(sig.dat, r)
  sig.dat$Genus <- droplevels(sig.dat$Genus)
  return(sig.dat)
}

htroph.df <- we2.htroph
cyano.df <- we2.bray.d
i = 1
physeq.scale <- heteros.scale.we2
```


```{r}
heteros.scale <-
   erie %>%
   subset_samples(Fraction == "CNA") %>%
   subset_taxa(Class != "Cyanobacteria") %>%
   scale_reads(round = "round") 
  
tax_mean <- taxa_sums(heteros.scale)/nsamples(heteros.scale)
heteros.scale.prune <- prune_taxa(tax_mean > thresh*n, heteros.scale) # 401 taxa

  

heteros.scale.we2 <- subset_samples(heteros.scale.prune, Station == "nearshore")
  
h.brayt1 <-
  h %>%
    filter(BrayType == "Bray-Curtis from t1") 

we2.bray <- filter(h.brayt1, Station == "Station 2")
we2.bray.d <- select(we2.bray, Dist)


we2.htroph <- t(otu_table(heteros.scale.we2))

t <- test_htroph_corr(htroph.df = we2.htroph, cyano.df = we2.bray.d, i = 1, physeq.scale = heteros.scale.we2)


corr <- corr.test(we2.htroph, we2.bray.d, use = "everything", method = "spearman", adjust = "bonferroni")


```

# 

Group dates into bloom and nonbloom and use deseq2 to find differentially abundant OTUs
```{r}

# Determine which dates are bloom
h.brayt1 %>%
  filter(Dist > .55) %>%
  select(Date, Station)

sample_data(heteros.scale.we2)$Bloom <- c(rep("low", 7), rep("high", 4), rep("low",7))

we2.deseq <- phyloseq_to_deseq2(heteros.scale.we2, ~Bloom)
we2.deseq = DESeq(we2.deseq,test = "Wald", fitType = "parametric")

res = as.data.frame(results(we2.deseq, cooksCutoff = FALSE))
alpha = 0.05
sigtab <-
  res %>%
    filter(padj < alpha) %>%
    filter( abs(log2FoldChange) - lfcSE > 1.5)


sigtab = cbind(sigtab, as(tax_table(heteros.scale.we2)[rownames(sigtab), ], "matrix"))
################

res = results(we2.deseq, cooksCutoff = FALSE)
alpha = 0.01
sigtab2 = res[which(res$padj < alpha), ]
sigtab2 = cbind(as(sigtab2, "data.frame"), as(tax_table(heteros.scale.we2)[rownames(sigtab2), ], "matrix"))
head(sigtab2)

scale_fill_discrete <- function(palname = "Set1", ...) {
    scale_fill_brewer(palette = palname, ...)
}
# Phylum order
x = tapply(sigtab$log2FoldChange, sigtab$Phylum, function(x) max(x))
x = sort(x, TRUE)
sigtab$Phylum = factor(as.character(sigtab$Phylum), levels=names(x))
# Genus order
x = tapply(sigtab$log2FoldChange, sigtab$Genus, function(x) max(x))
x = sort(x, TRUE)
sigtab$Genus = factor(as.character(sigtab$Genus), levels=names(x))
ggplot(sigtab, aes(x=Genus, y=log2FoldChange, color=Phylum)) + geom_point(size=6) + 
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5))



########### WE12 #########

heteros.scale.we12 <- subset_samples(heteros.scale.prune, Station == "Toledo")

sample_data(heteros.scale.we12)$Bloom <- c(rep("low", 7), rep("high", 5), rep("low", 6))

we12.deseq <- phyloseq_to_deseq2(heteros.scale.we12, ~Bloom)
we12.deseq = DESeq(we12.deseq,test = "Wald", fitType = "parametric")

res = results(we12.deseq, cooksCutoff = FALSE)
alpha = 0.01
sigtab12 = res[which(res$padj < alpha), ]
sigtab12 = cbind(as(sigtab12, "data.frame"), as(tax_table(heteros.scale.we12)[rownames(sigtab12), ], "matrix"))


####### WE4 ###############
heteros.scale.we4 <- subset_samples(heteros.scale.prune, Station == "offshore")

sample_data(heteros.scale.we4)$Bloom <- c(rep("low", 9), rep("high", 2), rep("low", 6))

we4.deseq <- phyloseq_to_deseq2(heteros.scale.we4, ~Bloom)
we4.deseq = DESeq(we4.deseq,test = "Wald", fitType = "parametric")

res = results(we4.deseq, cooksCutoff = FALSE)
alpha = 0.01
sigtab4 = res[which(res$padj < alpha), ]
sigtab4 = cbind(as(sigtab4, "data.frame"), as(tax_table(heteros.scale.we4)[rownames(sigtab4), ], "matrix"))


##############


sigtab12p <- filter(sigtab12, log2FoldChange < 0)
sigtab2p <- filter(sigtab2, log2FoldChange < 0)
sigtab4p <- filter(sigtab4, log2FoldChange < 0)
i <- intersect(sigtab2p$Species, sigtab12p$Species)
i <- intersect(i, sigtab4p$Species)
```


# Supplement

```{r echo = FALSE}
#othernuts <- map
#othernuts <- order_dates(othernuts)
#othernuts <- arrange(othernuts, Date)
#othernuts$Station <- factor(othernuts$Station, levels = c("WE2", "WE4", "WE12"))
#othernuts$Secchi[othernuts$Secchi == "n/a"] <- "NA"
#othernuts$Secchi <- as.numeric(as.vector(othernuts$Secchi))


```






## S1 Nutrient data
```{r echo = FALSE, fig.height= 10, fig.width = 10}
# Import metadata file with nutrients, pigments and toxin
nutrient <- read.csv("other/nutrients.csv")


# Format
nutrient <-
  nutrient %>%
    filter(!(Date %in% c("5/27","6/10", "11/3"))) %>%
    order_dates() 


%>%
    mutate(Station = recode(Station, "'WE2' = 'nearshore'; 'WE12' = 'Toledo'; 'WE4' = 'offshore'"))


nutplot_unpooled <- function(df, nutrient, title) {
        ggplot(df, aes_string(
                x = "Date",
                y = nutrient,
                group = "Station", 
                shape = "Station", 
                color = "Station")
        ) +
    geom_line(size = 0.8) +
    geom_point(size = 1.8) +
    ggtitle(title) + 
    xlab("") + ylab("ug/L") +       
    scale_color_manual(values = c("#E96446","#52361b","#87CEFA")) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 9, face = "bold"),     
          axis.title.y = element_text(size = 14),
          plot.title = element_text(size = 16, face = "bold"))
}

# Plot phosphorus
p.SRP <- nutplot_unpooled(nutrient, "SRP", "SRP")
                                  
# Plot nitrate
p.NO3 <- nutplot_unpooled(nutrient, "Nitrate", "Nitrate")
  
# Plot H202 
p.h202 <- nutplot_unpooled(nutrient, "H2O2", "H2O2")

# Plot temp
p.temp <- nutplot_unpooled(nutrient, "Temp", "Temperature")

# Plot turbidity
p.turb <- nutplot_unpooled(nutrient, "Turbidity", "Turbidity")

# plot pH
p.ph <- nutplot_unpooled(nutrient, "pH", "pH")

# multiplot
grid_arrange_shared_legend(p.NO3, p.ph, p.turb, p.temp, p.SRP, p.h202)

```



```{r include = FALSE, echo = FALSE, eval = FALSE}



# Plot phycocyanin ; note this has a special scaling
nutrient <-
  nutrient %>%
    mutate(Phyco.trans = Phycocyanin) 

#nutrient %>%
  #filter(Date %in% c("8/11", "9/29"))

nutrient$Phyco.trans[25] <- nutrient$Phyco.trans[25]/2
nutrient$Phyco.trans[46] <- nutrient$Phyco.trans[46]/2


```



## S2: Phylum composition of full community across sites

```{r composition barplot, echo = FALSE, fig.height = 10, fig.width = 14}
# Subset to full community,
# Transform to long format and prune out phyla below 2% in each sample
# for easier to read stacked barplot
erie.811 <-
  mothur.merge %>%
  subset_taxa(Kingdom == "Bacteria" &
                Family  != "mitochondria" &
                Class   != "Chloroplast"
                ) %>%
    subset_samples(Type == "sample") %>%
    subset_samples(!(Date %in% c ("5/27", "6/10", "11/3")))

erie.811 <- prune_taxa(taxa_sums(erie.811) > 0, erie.811)

Full.long <-
    erie.811 %>%
      subset_samples(Fraction == "CNA") %>%
      taxglom_and_melt(taxrank = "Phylum", prune = 0.02) %>%
      mutate(Station = recode(Station, "'WE2' = 'nearshore'; 'WE12' = 'Toledo'; 'WE4' = 'offshore'")) %>%
      habs_format() 
      

# Set colors for plotting
phylum.colors <- c(
  "#CBD588", "#5F7FC7", "orange","#DA5724", "#508578", "#CD9BCD",
   "#AD6F3B", "#673770","#D14285", "#652926", "#C84248", 
  "#8569D5", "#5E738F","#D1A33D", "#8A7C64", "#599861"
)


# Plot 
ggplot(Full.long, aes(x = Date, y = Abundance, fill = Phylum)) + 
  facet_grid(Station~., scales = "free_y") +
  geom_bar(stat = "identity") +
  geom_bar(
    stat = "identity", 
    position = "fill", 
    colour = "black", 
    show_guide = FALSE
  ) + 
  scale_fill_manual(values = phylum.colors) +
  scale_x_discrete(
    breaks = c("6/10", "7/8", "8/4", "9/2", "10/6", "11/3"),
    labels = c("Jun", "Jul", "Aug", "Sep", "Oct", "Nov"), 
    drop = FALSE
  ) + 
  stackbar_theme +
  guides(fill = guide_legend(reverse = TRUE, keywidth = 1, keyheight = 1)) +
  xlab("") +
  ylab("Relative Abundance (Phyla > 2%) \n") +
  ggtitle("Phylum Composition of Lake Erie \nBacterial Community by Sampling Site \n") 
        
```


