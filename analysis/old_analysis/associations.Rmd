---
title: 'Lake Erie HABs Community Manuscript'
output: html_document
---

# Introduction

Questions:

Broad: What determines community structure in Lake Erie during the bloom season?

Specific: 

1) Which environmental variables determine the composition of cyanobacterial taxa? Are there negative or positive correlations between different blooming genera?
    
2) Are heterotrophic communities driven by associations with specific cyanobacterial taxa or by environmental fluctuations (i.e. in source and level of organic carbon)
 - We can use our fractionated data to distinguish heterotrophs that are physically attached to cyanobacterial colonies vs free-living 


# Results

```{r load libraries, warning = FALSE, message = FALSE, echo = FALSE}
#Load libraries
library(phyloseq)
library(ggplot2)
library(dplyr)
library(scales)
library(grid)
library(reshape2)
library(gridExtra)
library(RColorBrewer)
library(vegan)
library(magrittr)
library(knitr)
source("habs_functions.R")
source("miseqR.R")
theme_set(theme_bw())
```

```{r mothur import, echo = FALSE}

# Import mothur files and sample metadata
sharedfile = "mothur/allhabs.shared"
taxfile = "mothur/allhabs.taxonomy"
mapfile = "other/habs_metadata.csv"
 
mothurdata = import_mothur(mothur_shared_file = sharedfile, 
	mothur_constaxonomy_file = taxfile)

# Add the OTU number as a column in the taxonomy file
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
	row.names(tax_table(mothurdata)))

# Rename the taxonomy columns
colnames(tax_table(mothurdata)) <- c("Kingdom", "Phylum", "Class", "Order", 
	"Family", "Genus", "Species")
  
# Import sample metadata
map <- read.csv(mapfile)
map <- sample_data(map)
rownames(map) <- map$SampleID
  
# Merge mothurdata object with sample metadata
moth_merge <- merge_phyloseq(mothurdata, map)

# Filter out non-samples (i.e. water,mock) and samples from intensive cruises.
# Also prune out taxa which were only present in removed samples
moth_chloro <- subset_samples(moth_merge,Type == "sample")
moth_chloro <- prune_taxa(taxa_sums(moth_chloro) > 0, moth_chloro)

# Filter out non-bacteria, chloroplasts and mitochondria
moth_chloro %>%
  subset_taxa(Kingdom == "Bacteria" & Family != "mitochondria" & Class != "Chloroplast") -> moth_good

phylum.colors <- c("#CBD588", "#5F7FC7", "orange", "#DA5724", "#89C5DA",
	"#508578", "#CD9BCD", "#74D944", "#D7C1B1", "#AD6F3B", "#673770","#D14285",
	"#689030", "#6DDE88", "#652926", "#7FDCC0", "#C84248", "#8569D5", "#5E738F",
	"#D1A33D", "#8A7C64", "#599861"
)

```

```{r echo=FALSE}
stackbar_theme <- theme(
  axis.title.x = element_text(size = 16,face = "bold"),
  axis.text.x = element_text(angle = 50, 
    face = "bold", 
    vjust = 1, 
    hjust = 1, 
    size = 15),
  axis.text.y = element_text(colour = "black", size = 10),
  axis.title.y = element_text(face = "bold", size = 16),
  plot.title = element_text(face = "bold", size = 22),
  legend.title = element_text(face = "bold", size = 16),
  legend.text = element_text(size = 14),
  strip.text.x = element_text(size = 16, face = "bold"),
  strip.text.y = element_text(size = 16, face = "bold"),
  strip.background = element_rect(color = "white",size = 2, fill = NA),
  panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.border = element_rect(colour = "black", fill = NA, size = 1.5),
  panel.margin = unit(1, "lines")
) 
```

# Cyanobacteria Genera
Time series of cyanobacteria genus relative abundance
```{r cyano, echo = FALSE, fig.width = 14, fig.height = 10}
# Create a melted data frame of cyano abundance in full community samples
moth_good %>% 
  subset_samples(Fraction == "CNA") %>%
  scale_reads(round = "round") %>%
  subset_taxa(Genus %in% c("Anabaena", "Microcystis", "Pseudanabaena",
                           "Synechococcus", "Limnohabitans")) %>%
  tax_glom(taxrank = "Genus") %>%
  psmelt() %>%
  order_dates() -> cyano.melt

ggplot(cyano.melt, aes(x = Date, y = Abundance, group = Genus, col = Genus)) + 
  facet_grid(Station~. ) + 
  geom_line() + 
  theme(
    axis.text.x = element_text(angle = 50, 
    face = "bold", 
    vjust = 1, 
    hjust = 1, 
    size = 15)
  )


```

```{r echo = FALSE, message = FALSE, warning = FALSE}
thresh = 0.0001
n <- 15000

moth_good %>%
  subset_samples(Fraction == "CNA") %>%
  scale_reads(n =  n, round = "round") -> CNA.scale


# Prune low abundance taxa
tax_mean <- taxa_sums(CNA.scale)/nsamples(CNA.scale)
CNA.scale.prune <- prune_taxa(tax_mean > thresh*n, CNA.scale)

# Heterotrophs: subset and separate otu table
CNA.scale.prune %>%
  subset_taxa(Phylum != "Cyanobacteria") -> htrophs

htrophs.otu <- t(otu_table(htrophs))

# Cyanobacteria: subset and separate otu table
CNA.scale.prune %>%
  subset_taxa(Phylum == "Cyanobacteria") -> cyanos

tax_table(cyanos)
```

This is weird .  . .

```{r}

cyanos %>%
  subset_taxa(Class == "Cyanobacteria") -> cyanos

cyanos.otu <- t(otu_table(cyanos))
cyanos.melt <- psmelt(cyanos.otu)
```

For all correlation analyses, I removed low abundance OTUs (mean abundance < 0.0001 of total reads per sample i.e `r thresh*n` ) which left a total of `r ncol(htrophs.otu)` heterotroph OTUs and `r ncol(cyanos.otu)` cyanobacteria OTUs. 


# Associations between cyanobacteria OTUs

These are spearman correlations with bonferroni correction between cyanobacterial OTUs 
```{r echo = FALSE, messages = FALSE, warnings = FALSE}
library(psych)
colnames(cyanos.otu) <- paste(tax_table(cyanos)[,"Genus"], 
  tax_table(cyanos)[ ,"Species"])

c <- corr.test(cyanos.otu, 
               method = "spearman", 
               use = "complete", 
               adjust = "bonferroni")

r.melt <- melt(c$r)
p.melt <- melt(c$p)
m <- merge(r.melt, p.melt, by = c("Var1","Var2"))
names(m) <- c("OTU1", "OTU2", "r", "pvalue")

m %>%
  filter(pvalue < 0.05 & pvalue > 0) %>%
  arrange(desc(r)) -> m


kable(m)

```



# Heterotrophic associates
   
Here we will examine correlations between cyanobacteria OTUs and heterotrophic OTUs in the full community



```{r echo = FALSE}
cyano_corrs <- list()

# Loop through each cyanobacteria taxa and run correlation statistics
for (i in 1:ncol(cyanos.otu)){
 
  # Run spearman correlation test with bonferroni correction
  cyano_corrs[[i]] <- test_htroph_corr(
    htrophs.otu,
    cyanos.otu,
    i, 
    CNA.scale.prune
  )
  
  # Name the elements of the list as the Genus + OTU
  names(cyano_corrs)[i] <- paste(tax_table(cyanos)[i,"Genus"], 
                                 tax_table(cyanos)[i,"Species"])
  
}


```
           

             
## Summary statistics for the associates


### `r names(cyano_corrs)[1]`  

```{r echo = FALSE, fig.height=6, fig.width=12}
cyanos %>% 
  subset_taxa(Species == "Otu00005") %>%
  psmelt() %>%
  order_dates() -> cyanos.melt

ggplot(cyanos.melt, aes(x = Date, y = Abundance, group = Station, color = Station)) +
  geom_point() + 
  geom_line() + 
  stackbar_theme


```


The number of positive associates is `r length(which(cyano_corrs[[1]][,2] > 0))`          
The number of negative associates is `r length(which(cyano_corrs[[1]][,2] < 0))`                
Genera represented by positive associates:
```{r echo = FALSE} 
table(cyano_corrs[[1]][which(cyano_corrs[[1]][ ,2] > 0), 8])

```
           
         
Genera represented by negative associates:
```{r echo = FALSE} 
table(cyano_corrs[[1]][which(cyano_corrs[[1]][ ,2] < 0), 8]) 
```



### `r names(cyano_corrs)[2]`

```{r echo = FALSE, fig.height=6, fig.width=12}
cyanos %>% 
  subset_taxa(Species == "Otu00007") %>%
  psmelt() %>%
  order_dates() -> cyanos.melt

ggplot(cyanos.melt, aes(x = Date, y = Abundance, group = Station, color = Station)) +
  geom_point() + 
  geom_line() + 
  stackbar_theme


```

The number of positive associates is `r length(which(cyano_corrs[[2]][,2] > 0))`                
The number of negative associates is `r length(which(cyano_corrs[[2]][,2] < 0))`               

Genera represented by positive associates: 
```{r echo = FALSE} 
table(cyano_corrs[[2]][which(cyano_corrs[[2]][ ,2] > 0), 8])

```
           
         
Genera represented by negative associates: 
```{r echo = FALSE} 
table(cyano_corrs[[2]][which(cyano_corrs[[2]][ ,2] < 0), 8]) 
```


### `r names(cyano_corrs)[3]`
```{r echo = FALSE, fig.height=6, fig.width=12}
cyanos %>% 
  subset_taxa(Species == "Otu00037") %>%
  psmelt() %>%
  order_dates() -> cyanos.melt

ggplot(cyanos.melt, aes(x = Date, y = Abundance, group = Station, color = Station)) +
  geom_point() + 
  geom_line() + 
  stackbar_theme


```
The number of positive associates is `r length(which(cyano_corrs[[3]][,2] > 0))`          
The number of negative associates is `r length(which(cyano_corrs[[3]][,2] < 0))`    

Genera represented by positive associates:
```{r echo = FALSE} 
table(cyano_corrs[[3]][which(cyano_corrs[[3]][ ,2] > 0), 8])

```
           
         
Genera represented by negative associates:
```{r echo = FALSE} 
table(cyano_corrs[[3]][which(cyano_corrs[[3]][ ,2] < 0), 8]) 
```


### `r names(cyano_corrs)[4]`
```{r echo = FALSE, fig.height=6, fig.width=12}
cyanos %>% 
  subset_taxa(Species == "Otu00044") %>%
  psmelt() %>%
  order_dates() -> cyanos.melt

ggplot(cyanos.melt, aes(x = Date, y = Abundance, group = Station, color = Station)) +
  geom_point() + 
  geom_line() + 
  stackbar_theme


```
The number of positive associates is `r length(which(cyano_corrs[[4]][,2] > 0))`                
The number of negative associates is `r length(which(cyano_corrs[[4]][,2] < 0))`  


Genera represented by positive associates:
```{r echo = FALSE} 
table(cyano_corrs[[4]][which(cyano_corrs[[4]][ ,2] > 0), 8])

```
           
         
Genera represented by negative associates:
```{r echo = FALSE} 
table(cyano_corrs[[4]][which(cyano_corrs[[4]][ ,2] < 0), 8]) 
```


### `r names(cyano_corrs)[5]`
```{r echo = FALSE, fig.height=6, fig.width=12}
cyanos %>% 
  subset_taxa(Species == "Otu00049") %>%
  psmelt() %>%
  order_dates() -> cyanos.melt

ggplot(cyanos.melt, aes(x = Date, y = Abundance, group = Station, color = Station)) +
  geom_point() + 
  geom_line() + 
  stackbar_theme


```
The number of positive associates is `r length(which(cyano_corrs[[5]][,2] > 0))`      
The number of negative associates is `r length(which(cyano_corrs[[5]][,2] < 0))`    

Genera represented by positive associates:
```{r echo = FALSE} 
table(cyano_corrs[[5]][which(cyano_corrs[[5]][ ,2] > 0), 8])

```
           
         
Genera represented by negative associates:
```{r echo = FALSE} 
table(cyano_corrs[[5]][which(cyano_corrs[[5]][ ,2] < 0), 8]) 
```


### `r names(cyano_corrs)[6]`
```{r echo = FALSE, fig.height=6, fig.width=12}
cyanos %>% 
  subset_taxa(Species == "Otu00063") %>%
  psmelt() %>%
  order_dates() -> cyanos.melt

ggplot(cyanos.melt, aes(x = Date, y = Abundance, group = Station, color = Station)) +
  geom_point() + 
  geom_line() + 
  stackbar_theme


```
The number of positive associates is `r length(which(cyano_corrs[[6]][,2] > 0))`          
The number of negative associates is `r length(which(cyano_corrs[[6]][,2] < 0))`    

      
Genera represented by positive associates:
```{r echo = FALSE} 
table(cyano_corrs[[6]][which(cyano_corrs[[6]][ ,2] > 0), 8])

```
           
         
Genera represented by negative associates:
```{r echo = FALSE} 
table(cyano_corrs[[6]][which(cyano_corrs[[6]][ ,2] < 0), 8]) 
```


### `r names(cyano_corrs)[7]`
```{r echo = FALSE, fig.height=6, fig.width=12}
cyanos %>% 
  subset_taxa(Species == "Otu00147") %>%
  psmelt() %>%
  order_dates() -> cyanos.melt

ggplot(cyanos.melt, aes(x = Date, y = Abundance, group = Station, color = Station)) +
  geom_point() + 
  geom_line() + 
  stackbar_theme


```
The number of positive associates is `r length(which(cyano_corrs[[7]][,2] > 0))`      
The number of negative associates is `r length(which(cyano_corrs[[7]][,2] < 0))`          
Genera represented by positive associates:
```{r echo = FALSE} 
table(cyano_corrs[[7]][which(cyano_corrs[[7]][ ,2] > 0), 8])

```
           
         
Genera represented by negative associates:
```{r echo = FALSE} 
table(cyano_corrs[[7]][which(cyano_corrs[[7]][ ,2] < 0), 8]) 
```


### `r names(cyano_corrs)[8]`
```{r echo = FALSE, fig.height=6, fig.width=12}
cyanos %>% 
  subset_taxa(Species == "Otu00177") %>%
  psmelt() %>%
  order_dates() -> cyanos.melt

ggplot(cyanos.melt, aes(x = Date, y = Abundance, group = Station, color = Station)) +
  geom_point() + 
  geom_line() + 
  stackbar_theme


```
The number of positive associates is `r length(which(cyano_corrs[[8]][,2] > 0))`        
The number of negative associates is `r length(which(cyano_corrs[[8]][,2] < 0))`       

Genera represented by positive associates:
```{r echo = FALSE} 
table(cyano_corrs[[8]][which(cyano_corrs[[8]][ ,2] > 0), 8])

```
           
         
Genera represented by negative associates:
```{r echo = FALSE} 
table(cyano_corrs[[8]][which(cyano_corrs[[8]][ ,2] < 0), 8]) 
```

### `r names(cyano_corrs)[9]`
```{r echo = FALSE, fig.height=6, fig.width=12}
cyanos %>% 
  subset_taxa(Species == "Otu00193") %>%
  psmelt() %>%
  order_dates() -> cyanos.melt

ggplot(cyanos.melt, aes(x = Date, y = Abundance, group = Station, color = Station)) +
  geom_point() + 
  geom_line() + 
  stackbar_theme


```
The number of positive associates is `r length(which(cyano_corrs[[9]][,2] > 0))`             
The number of negative associates is `r length(which(cyano_corrs[[9]][,2] < 0))`    

Genera represented by positive associates:
```{r echo = FALSE} 
table(cyano_corrs[[9]][which(cyano_corrs[[9]][ ,2] > 0), 8])

```
           
         
Genera represented by negative associates:
```{r echo = FALSE} 
table(cyano_corrs[[9]][which(cyano_corrs[[9]][ ,2] < 0), 8]) 
```


### `r names(cyano_corrs)[10]`
```{r echo = FALSE, fig.height=6, fig.width=12}
cyanos %>% 
  subset_taxa(Species == "Otu00304") %>%
  psmelt() %>%
  order_dates() -> cyanos.melt

ggplot(cyanos.melt, aes(x = Date, y = Abundance, group = Station, color = Station)) +
  geom_point() + 
  geom_line() + 
  stackbar_theme


```
The number of positive associates is `r length(which(cyano_corrs[[10]][,2] > 0))`                   
The number of negative associates is `r length(which(cyano_corrs[[10]][,2] < 0))`   

Genera represented by positive associates:
```{r echo = FALSE} 
table(cyano_corrs[[10]][which(cyano_corrs[[10]][ ,2] > 0), 8])

```
           
         
Genera represented by negative associates:
```{r echo = FALSE} 
table(cyano_corrs[[10]][which(cyano_corrs[[10]][ ,2] < 0), 8]) 
```


### `r names(cyano_corrs)[11]`
```{r echo = FALSE, fig.height=6, fig.width=12}
cyanos %>% 
  subset_taxa(Species == "Otu00403") %>%
  psmelt() %>%
  order_dates() -> cyanos.melt

ggplot(cyanos.melt, aes(x = Date, y = Abundance, group = Station, color = Station)) +
  geom_point() + 
  geom_line() + 
  stackbar_theme


```
The number of positive associates is `r length(which(cyano_corrs[[11]][,2] > 0))`               
The number of negative associates is `r length(which(cyano_corrs[[11]][,2] < 0))`         

Genera represented by positive associates:
```{r echo = FALSE} 
table(cyano_corrs[[11]][which(cyano_corrs[[11]][ ,2] > 0), 8])

```
           
         
Genera represented by negative associates:
```{r echo = FALSE} 
table(cyano_corrs[[11]][which(cyano_corrs[[11]][ ,2] < 0), 8]) 
```

# Colonial Associates
     
Here we will examine differences between heterotrophic associates in the colonial fractions for microcystis and synechococcus to see which heterotrophs are assoiated because they're actually attaching to colonies
```{r echo=FALSE}
moth_good %>%
  subset_samples(Fraction == "100LTR") %>%
  scale_reads(n =  500, round = "round") -> colony.scale


# Prune low abundance taxa
tax_mean <- taxa_sums(colony.scale)/nsamples(colony.scale)
colony.prune <- prune_taxa(tax_mean > 0.001*500, colony.scale)

# Heterotrophs: subset and separate otu table
colony.prune %>%
  subset_taxa(Phylum != "Cyanobacteria") -> htrophs

htrophs.otu <- t(otu_table(htrophs))

# Cyanobacteria: subset and separate otu table
colony.prune %>%
  subset_taxa(Phylum == "Cyanobacteria") -> cyanos

cyanos.otu <- t(otu_table(cyanos))
cyanos.melt <- psmelt(cyanos.otu)



```

```{r echo = FALSE}
cyano_corrs <- list()

# Loop through each cyanobacteria taxa and run correlation statistics
for (i in 1:ncol(cyanos.otu)){
 
  # Run spearman correlation test with bonferroni correction
  cyano_corrs[[i]] <- test_htroph_corr(
    htrophs.otu,
    cyanos.otu,
    i, 
    colony.prune
  )
  
  # Name the elements of the list as the Genus + OTU
  names(cyano_corrs)[i] <- paste(tax_table(cyanos)[i,"Genus"], 
                                 tax_table(cyanos)[i,"Species"])
  
}

```
## Microcystis colonies
```{r}
cyanos %>% 
  subset_taxa(Species == "Otu00005") %>%
  psmelt() %>%
  order_dates() -> cyanos.melt

ggplot(cyanos.melt, aes(x = Date, y = Abundance, group = Station, color = Station)) +
  geom_point() + 
  geom_line() + 
  stackbar_theme



```

The number of positive associates is `r length(which(cyano_corrs[[1]][,2] > 0))`               
The number of negative associates is `r length(which(cyano_corrs[[1]][,2] < 0))`         

Genera represented by positive associates:
```{r echo = FALSE} 
table(cyano_corrs[[1]][which(cyano_corrs[[1]][ ,2] > 0), 8])

```
           
         
Genera represented by negative associates:
```{r echo = FALSE} 
table(cyano_corrs[[1]][which(cyano_corrs[[1]][ ,2] < 0), 8]) 
```

## Synechococcus colonies Otu00007

```{r}
cyanos %>% 
  subset_taxa(Species == "Otu00007") %>%
  psmelt() %>%
  order_dates() -> cyanos.melt

ggplot(cyanos.melt, aes(x = Date, y = Abundance, group = Station, color = Station)) +
  geom_point() + 
  geom_line() + 
  stackbar_theme



```

The number of positive associates is `r length(which(cyano_corrs[[2]][,2] > 0))`               
The number of negative associates is `r length(which(cyano_corrs[[2]][,2] < 0))`         

Genera represented by positive associates:
```{r echo = FALSE} 
table(cyano_corrs[[2]][which(cyano_corrs[[2]][ ,2] > 0), 8])

```
           
         
Genera represented by negative associates:
```{r echo = FALSE} 
table(cyano_corrs[[2]][which(cyano_corrs[[2]][ ,2] < 0), 8]) 
```

## Synechococcus colonies Otu00044
```{r}
cyanos %>% 
  subset_taxa(Species == "Otu00044") %>%
  psmelt() %>%
  order_dates() -> cyanos.melt

ggplot(cyanos.melt, aes(x = Date, y = Abundance, group = Station, color = Station)) +
  geom_point() + 
  geom_line() + 
  stackbar_theme



```

The number of positive associates is `r length(which(cyano_corrs[[4]][,2] > 0))`               
The number of negative associates is `r length(which(cyano_corrs[[4]][,2] < 0))`         

Genera represented by positive associates:
```{r echo = FALSE} 
table(cyano_corrs[[4]][which(cyano_corrs[[4]][ ,2] > 0), 8])

```
           
         
Genera represented by negative associates:
```{r echo = FALSE} 
table(cyano_corrs[[4]][which(cyano_corrs[[4]][ ,2] < 0), 8]) 
```


# 53um colonial associates
```{r echo=FALSE}
moth_good %>%
  subset_samples(Fraction == "53LTR") %>%
  scale_reads(n =  500, round = "round") -> colony.scale


# Prune low abundance taxa
tax_mean <- taxa_sums(colony.scale)/nsamples(colony.scale)
colony.prune <- prune_taxa(tax_mean > 0.001*500, colony.scale)

# Heterotrophs: subset and separate otu table
colony.prune %>%
  subset_taxa(Phylum != "Cyanobacteria") -> htrophs

htrophs.otu <- t(otu_table(htrophs))

# Cyanobacteria: subset and separate otu table
colony.prune %>%
  subset_taxa(Class == "Cyanobacteria") -> cyanos

cyanos.otu <- t(otu_table(cyanos))
cyanos.melt <- psmelt(cyanos.otu)

cyano_corrs <- list()

# Loop through each cyanobacteria taxa and run correlation statistics
for (i in 1:ncol(cyanos.otu)){
 
  # Run spearman correlation test with bonferroni correction
  cyano_corrs[[i]] <- test_htroph_corr(
    htrophs.otu,
    cyanos.otu,
    i, 
    colony.prune
  )
  
  # Name the elements of the list as the Genus + OTU
  names(cyano_corrs)[i] <- paste(tax_table(cyanos)[i,"Genus"], 
                                 tax_table(cyanos)[i,"Species"])
  
}




```

## Microcystis colonies
```{r}
cyanos %>% 
  subset_taxa(Species == "Otu00005") %>%
  psmelt() %>%
  order_dates() -> cyanos.melt

ggplot(cyanos.melt, aes(x = Date, y = Abundance, group = Station, color = Station)) +
  geom_point() + 
  geom_line() + 
  stackbar_theme



```

The number of positive associates is `r length(which(cyano_corrs[[1]][,2] > 0))`               
The number of negative associates is `r length(which(cyano_corrs[[1]][,2] < 0))`         

Genera represented by positive associates:
```{r echo = FALSE} 
table(cyano_corrs[[1]][which(cyano_corrs[[1]][ ,2] > 0), 8])

```
           
         
Genera represented by negative associates:
```{r echo = FALSE} 
table(cyano_corrs[[1]][which(cyano_corrs[[1]][ ,2] < 0), 8]) 
```

## Synechococcus colonies Otu00007

```{r}
cyanos %>% 
  subset_taxa(Species == "Otu00007") %>%
  psmelt() %>%
  order_dates() -> cyanos.melt

ggplot(cyanos.melt, aes(x = Date, y = Abundance, group = Station, color = Station)) +
  geom_point() + 
  geom_line() + 
  stackbar_theme



```

The number of positive associates is `r length(which(cyano_corrs[[2]][,2] > 0))`               
The number of negative associates is `r length(which(cyano_corrs[[2]][,2] < 0))`         

Genera represented by positive associates:
```{r echo = FALSE} 
table(cyano_corrs[[2]][which(cyano_corrs[[2]][ ,2] > 0), 8])

```
           
         
Genera represented by negative associates:
```{r echo = FALSE} 
table(cyano_corrs[[2]][which(cyano_corrs[[2]][ ,2] < 0), 8]) 
```

## Synechococcus colonies Otu00044
```{r}
cyanos %>% 
  subset_taxa(Species == "Otu00044") %>%
  psmelt() %>%
  order_dates() -> cyanos.melt

ggplot(cyanos.melt, aes(x = Date, y = Abundance, group = Station, color = Station)) +
  geom_point() + 
  geom_line() + 
  stackbar_theme



```

The number of positive associates is `r length(which(cyano_corrs[[4]][,2] > 0))`               
The number of negative associates is `r length(which(cyano_corrs[[4]][,2] < 0))`         

Genera represented by positive associates:
```{r echo = FALSE} 
table(cyano_corrs[[4]][which(cyano_corrs[[4]][ ,2] > 0), 8])

```
           
         
Genera represented by negative associates:
```{r echo = FALSE} 
table(cyano_corrs[[4]][which(cyano_corrs[[4]][ ,2] < 0), 8]) 
```

# Bioenv
```{r echo = FALSE}
# Scale reads to even depth, format, and ordinate 
moth_good %>% 
  subset_samples(Fraction == "CNA") %>% 
  scale_reads(round = "round") %>% 
  habs_ord_format() -> full.format 

full.format %>%
  phyloseq::distance(method = "bray") -> full.bray

full.format %>%
  ordinate(method = "PCoA", distance = full.bray) -> full.pcoa


# Plot 
plot_ordination(
  physeq = full.format,
  ordination = full.pcoa,
  color = "Month",
  shape = "Station",
  title = "PCoA of Lake Erie bacterial Communities"
) + 
  scale_color_manual(values = c("#a65628", "red", "#ffae19",
    "#4daf4a", "#1919ff", "darkorchid3", "magenta")
  ) +
  geom_point(aes(color = Month), alpha = 0.7, size = 4) +
  geom_point(colour = "grey90", size = 1.5) 


### Bioenv #######
data.frame(sample_data(full.format)) %>%
  select(pH, Secchi, Temp, Turbidity, SRP, POC,
         Nitrate, Ammonia, H2O2, Chla, ParMC, Phycocyanin) %>%
  na.omit() -> env

# Fix this in sample_data
env$Secchi <- as.numeric(env$Secchi)

# remove NA's from bray dist object
full.bray <- as.matrix(full.bray)
bray.sub <- full.bray[rownames(env), rownames(env)]
bray.sub <- as.dist(bray.sub)
```

```{r}

b <- bioenv(bray.sub, env, method = "spearman", trace = T, upto = 12)

summary(b)

# Select best variables from env
env %>%
  select(pH, Temp, Turbidity) -> env.subset

# Scale env variables and calculate euclidean distance
env.scale <- scale(env.subset)
env.dist <- dist(env.scale, method = "euclidean")

# Run partial mantel 
mantel(bray.sub, env.dist, method = "spearman")


```




        

Here we will construct a regression tree with phototroph abundance as reponse and environmental conditions as predictors to understand the bottom up conditions that determine community of phototrophs


. . . in progress

# Kmeans
```{r}

o <- otu_table(CNA.scale.prune)

otu.kmeans <- kmeans(x = o,centers = 5)
 which(otu.kmeans$cluster==5)

o.scale <- scale(o)
otu.scale.kmeans <- kmeans(x = o,centers = 5)
which(otu.scale.kmeans$cluster==1)
# Microcystis and two frankiales



 s <- subset_taxa(CNA.scale.prune,Species %in% c("Otu00004", "Otu00005", "Otu00006"))
 
 s.melt <- psmelt(s)
 s.melt <- order_dates(s.melt)
 
 ggplot(s.melt, aes(x = Date, y = Abundance, group = Species, col = Species)) +
   facet_grid(Station~.) + 
   geom_line()
 
 ordinate(CNA.scale.prune, method = PCA, )
 
 plot_ordination(type = "species")
 
 
 full.format %>%
  ordinate(method = "NMDS", distance = "bray") -> full.pcoa
 
 plot_ordination(
  physeq = full.format,
  ordination = full.pcoa,
  type = "species",
  title = "PCoA of Lake Erie bacterial Communities"
) + 
  scale_color_manual(values = c("#a65628", "red", "#ffae19",
    "#4daf4a", "#1919ff", "darkorchid3", "magenta")
  ) 
 
 otu.pca <- log()
 otu.pca <- prcomp(o, center =TRUE, scale. = TRUE)
 
 +
  geom_point(aes(color = Month), alpha = 0.7, size = 4) +
  geom_point(colour = "grey90", size = 1.5) 

```

ggbiplot(otu.pca, obs.scale = 1, var.scale = 1,
              circle = TRUE)

